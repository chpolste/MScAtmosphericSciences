The only retrieval technique that does not depend on a numerical radiative
transfer model is regression based on a training data set of simultaneous
radiometer observations and radiosonde ascents. This requires long time series
of observations available only in very few locations. Instead retrieval schemes
use simulations of radiometer measurements in order to generate training data
sets or determine the likelihood of a brightness temperature measurement given
a vertical atmospheric profile.

A few common model are used: MONORTM (which is the basis of the previous
retrieval studies from Innsbruck), MPM, ARTS, .... TODO: refer to comparison
study. Currently developed: RTTOV-gb, which appears to be very promising.
Older models such as MONORTM appear to be slowly left behind as more and more
authors start to use optimal estimation techniques. Instead mature and more
modern projects such as ARTS and now also RTTOV-gb, which provide analytical
Jacobians are favored (show this with citations).

In this chapter: presentation of the basics of radiative transfer, discussion
of discretization techniques, linearization and error characterization. The
chapter ends with a custom implementation of an RTM containing only the bare
essentials but providing exact Jacobians. The model is supposed to
be a demonstration prototype optimized for ease of use, not computational
performance or accuracy.


\startsection[title=The Radiative Transfer Equation]

    The differential form of the radiative transfer equation in
    a non-scattering medium is given by
    \cite[alternative=authoryears,left={(e.g. }][Buehler2005]

    \placeformula[eq:rte_general]
    \startformula
        \DERIV{I_\nu}{s} = - I_\nu \ABSCOEF + F
    \stopformula

    where $I_\nu$ is radiative power per frequency, solid angle and area in
    a specific direction (spectral radiance), $\ABSCOEF$ is the absorption
    coefficient of the medium, $F$ contains all sources of radiation and $s$ is
    distance in beam direction. The only source term considered here is the
    emission of the medium itself in thermal equilibrium according to Plank's
    law

    \startformula
        F = \epsilon \, B_\nu(T)
    \stopformula

    where $\epsilon$ is the emission coefficient of the grey body and
    $B_\nu(T)$ is the Planck function describing the emitted spectral radiance
    of a black body at a given temperature $T$. The emission coefficient
    quantifies the difference of the medium to a perfect black body as
    described by the Planck function and dependent on the considered frequency.
    Because thermodynamic equilibrium is assumed Kirchhoff's law allows to
    equal the absorption and emission coefficients of the medium

    \startformula
        0 \le \ABSCOEF = \epsilon \le 1
    \stopformula

    Substituting the results of Plank's law and Kirchhoff's law into the
    radiative transfer equation \ineq{rte_general} yields

    \startformula
        \DERIV{I_\nu}{s} = - \ABSCOEF(I_\nu - B_\nu(T)) \EQSTOP
    \stopformula

    For temperatures occuring in the atmosphere and the spectral region of
    microwave radiation the Planck function $B_\nu (T)$ is approximated
    well by the Rayleigh-Jeans approximation which relates the spectral
    radiance at a given frequency linearly to temperature $T$

    \startformula
        B_\nu(T) \approx \frac{2 \nu^2 k T}{c^2}
    \stopformula

    where $c$ is the speed of light and $k$ is the Boltzmann constant.
    Microwave radiometers measure brightness temperatures instead of spectral
    radiances. Brightness temperature $\BT$ is the temperature of a black body
    that emits the same spectral radiance as an observed grey body. In the
    Rayleigh-Jeans limit the relationship between temperature and brightness
    temperature is particularly simple: $\BT = \epsilon \, T$. Expressing
    observed spectral radiance in terms of Planck emission and again
    applying the Rayleigh-Jeans approximation

    \startformula
        I_\nu := \epsilon \, B_\nu(T)
            \approx \epsilon \, \frac{2 \nu^2 k T}{c^2}
            = \frac{2 \nu^2 k}{c^2} \, \BT \EQCOMMA
    \stopformula

    and noting that the term $\frac{2 \nu^2 k}{c^2}$ is constant for a
    fixed frequency, the radiative transfer equation \ineq{rte_general} for
    a given frequency can be expressed exclusively in terms of temperature and
    brightness temperature

    \placeformula[eq:rte_radiometer]
    \startformula
        \DERIV{\BT}{s} = - \ABSCOEF (\BT - T) \EQSTOP
    \stopformula

    Because $T = T(s)$, analytical solutions of equation \ineq{rte_radiometer}
    can only be found in a few special cases and numerical solutions have to
    be seeked in general.

\stopsection


\startsection[title={A Solution for Ground-based Radiometer Applications}]

    For a radiometer looking up or at an angle to the side from the surface the
    absorbing and emitting medium is the atmosphere. To simulate a radiometer
    measurement by solving the radiative transfer equation, the atmospheric
    state has to be projected onto the light path observed by the radiometer.
    Since atmospheric state is usually known as a function of altitude the
    first step towards a solution of \ineq{rte_radiometer} is a coordinate
    transform into height coordinates

    \startformula
        \DERIV{s}{z} = - \frac{1}{\cos(\theta)} \EQSTOP
    \stopformula

    $z$ is the altitude coordinate and $\theta$ the zenith angle describing the
    deviation of the radiometers viewing direction from zenith. Because $z$
    increases with height but $s$ is the distance along the light path which
    points downward (the observed radiation is downwelling), $\DERIV{s}{z}$
    must be negative. It is convenient for the solution of
    \ineq{rte_radiometer} to introduce optical depth

    \startformula
    \startalign[n=3,align={left,right,left}]
        \NC \NC \OD(s) := \NC \int_{s_0}^{s} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \OD(z) = \NC
            - \frac{1}{\cos(\theta)} \int_{z_0}^{z} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \DERIV{\OD}{z} = \NC
            - \frac{\ABSCOEF}{\cos(\theta)} \EQSTOP \NR
    \stopalign
    \stopformula

    Applying the coordinate transformation to \ineq{rte_radiometer},
    multiplying by $e^{\OD}$ and applying the product rule of differentiation
    yields

    \startformula
        \DERIV{\BT}{z} e^\OD + \frac{\ABSCOEF \BT e^\OD}{\cos(\theta)}
        = \DERIV{(\BT e^\OD)}{z}
        = - \frac{\ABSCOEF T e^\OD}{\cos(\theta)} \EQSTOP
    \stopformula

    Integrating this differential equation from the surface ($z = 0$) to space
    ($z = \infty$) gives an expression for the brightness temperature observed
    by the (virtual) radiometer

    \placeformula[eq:rte_solution]
    \startformula
        \BT(0) = \BT(\infty) e^{\OD(\infty)} + \frac{1}{\cos(\theta)}
            \int_{0}^{\infty} \ABSCOEF(z) T(z) e^{\OD(z)} \diff z \EQSTOP
    \stopformula

    $T_B(\infty)$ is the brightness temperature of the cosmic background
    radiation which has a value of approximately 2.75 K for frequencies in the
    microwave spectrum \cite[authoryears][Westwater2004]. It is important to
    note that \ineq{rte_solution} is only valid at off-zenith angles if the
    vertical profiles of $T$ and $\ABSCOEF$ are horizontally homogeneous and if
    refraction of light and Earth's curvature are neglected. These restrictions
    are further discussed in section \in[ch:elevation_scanning].

\stopsection


\startsection[title={Atmospheric Extinction and Absorption Models},reference=ch:extinction]

    Simulation of brightness temperatures using \ineq{rte_solution} requires
    the determination of atmospheric absorption/emission coefficients. The
    review of \cite[Westwater2004] includes a chapter on the properties of
    atmospheric absorption in the microwave region from 20 to 200 GHz. Its main
    features are repeated here with some additions. Also discussed are
    numerical models for calculation of absorption coefficients.

    \placefigure[top][fig:absorption]
        {Absorption coefficients (black) and contributions of individual terms
        (other) according to the models of \cite[Liebe1993] (gaseous) and
        \cite[Turner2016] (cloud) for a atmospheric layer at 850 hPa pressure,
        0°C temperature and saturation, containing 0.1 g/kg of liquid water.
        The arrows mark HATPRO channels.
        }
        {\externalfigure[absorption][width=\textwidth]}

    The three main constituents in the atmosphere contributing to extinction
    and emission of microwave radiation are oxygen, water vapor and liquid
    water. A typical absorption spectrum of an
    atmospheric layer is shown in Figure \in[fig:absorption]. Water vapor has
    a relatively weak absorption band around 22.235 GHz (K band) and oxygen
    a stronger band around 60 GHz (V band). Outside of the shown frequency
    range are also an oxygen absorption line at 118.75 GHz and a stronger water
    vapor line at 183.31 GHz. The wings of these lines and others outside the
    microwave region as well as broadening processes associated with pressure
    and interactions with other atmospheric species also contribute to the
    overall absorption as so-called continuum terms
    \cite[authoryears][Liebe1993,Hewison2006]. Finally, in the presence of
    clouds there is absorption by water droplets. Due to the
    size-wavelength-ratio of droplets in non-precipitating clouds and microwave
    radiation, scattering can be neglected and the Rayleigh-approximation is
    apropriate for the description of absorption of radiation by liquid water.
    Absorption and scattering by snow and ice in the atmosphere has negligible
    effect on radiation in the K and V bands \cite[authoryears][Sanchez2013].
    During rain events scattering of microwave radiation cannot be neglected
    and rainwater accumulation on the radiometer's radome must be accounted
    for as well. Since these effects are much more difficult to quantify than
    absorption they are usually not included in radiative transfer models and
    the resulting errors are accepted or retrievals are not performed during
    precipitation at all.

    The absorption spectrum in Figure \in[fig:absorption] was calculated by
    a model from \cite[Liebe1993] for gaseous absorption and a model from
    \cite[Turner2016] for absorption by cloud liquid water. There are multiple
    of such models in use, popular ones include a model by
    \cite[Rosenkranz1998], MonoRTM \cite[authoryears][Clough2005] and ARTS
    \cite[Buehler2005] (the latter two are not just absorption models but
    entire radiative transfer simulators). These model usually account for the
    most important absorption lines explicitly, correct for missing ones and
    parameterize the continuum term by an empirical function. The
    \cite[Liebe1993] model for example describes oxygen line absorption in the
    microwave region by 44 lines and water vapor by 34 lines. Cloud absorption
    is most often parameterized by a double-Debey model
    \cite[alternative=authoryears,left={(e.g. }][Turner2016]. Instead of only
    describing atmospheric absorption, these models are formulated in terms of
    the more general refractivity $N$ which is the complex refractive index
    reduced by one. With knowledge of $N$, absorption can be calculated by

    \startformula
        \ABSCOEF = \frac{4 \pi \nu}{c}~ {\rm Im}(N)
    \stopformula

    where $c$ is the speed of light and $\nu$ is frequency.

\stopsection


\startsection[title={State Vector Variables},reference={ch:statevector}]

    In order to determine atmospheric emission and absorption, the atmospheric
    state has to be represented somehow on the retrieval grid. Naively one
    would directly choose the quantites that are to be retrieved as state
    vector variables and this approach can work reasonably well for regression
    retrievals. Any method that makes the assumption of Gaussian distributed
    state vector variables however might require variable transformations to
    fulfil this requirement. For optimal estimation retrievals it is common to
    combine water vapor and liquid water into a single quantity and retrieve
    the logarithm of this quantity \cite[alternative=authoryears,left={(e.g.
    }][Lohnert2004,Hewison2006,Cimini2011]. Figure \in[fig:gauss_verification]
    shows the benefits of using the logarithm of humidity on the example of
    the climatological distribution at a single altitude: while temperatures in
    the atmosphere generally follow a Gaussian shape, humidity\footnote{In this
    case specific humidity but the same applies to water vapor density
    (absolute humidity) and relative humidity} is a positive variable and
    therefore not symmetrically distributed. Using its logarithm enforces
    positivity of values and reduces the skewness of the distribution, bringing
    it closer to a Gaussian shape.

    \placefigure[top][fig:gauss_verification]
        {Histograms of temperature (left), specific humidity (center) and
        the natural logarithm of specific humidity (right) for the 1339 m
        level of the radiosonde dataset (section \in[]).
        }
        {\externalfigure[gauss_verification][width=\textwidth]}

    Reducing water vapor and liquid water to a combined total water content
    variable is practical in multiple ways. In terms of the distribution
    functions the asymmetry found for liquid water content is even worse than
    for water vapor since many atmospheric profiles are cloud-free resulting
    in a mode at zero. Because the logarithm is not defined at zero a variable
    transformation does not help. Since there always is some water vapor in the
    atmosphere this mathematical problem is avoided by adding both components
    of water content and then applying the logarithm transformation. Another
    advantage of the combined variable is the reduction of state vector
    dimensionality resulting in smaller Jacobians and computationally faster
    optimal estimation retrievals. Of course the combination is only sensible
    if there is a way to separate the components again for the calculation of
    absorption coefficients.

    Because the effect of ice on microwave radiative transfer is negligible
    (see section \in[ch:extinction]) only water vapor and liquid has to be
    included in the total water content variable and subsequently separated.
    The governing quantity of the partitioning scheme is the saturation vapor
    pressure since it determines when the capabilities of the gaseos water
    content is exceeded and cloud droplets form. Since saturation vapor
    pressure is a function of temperature alone, it is possible to calculate
    the separation threshold from known quantities of the atmospheric state. In
    order to achive differentiability the chosen partition function has
    a transition region starting at 95 \% relative humidity. This approach has
    previously been employed by \cite[Hewison2006] who modified it from
    \cite[Deblonde2003]. The chosen form here is

    \startformula
        \DERIV{\QLIQ}{\RHL} = \QSAT \startcases
            \NC 0 \MC s \lt 0.95 \NR
            \NC \cos \left( \frac{\RHL - 1.05}{0.1} \frac{\pi}{2} \right)^2
                \MC 0.95 \le s \le 1.05 \EQCOMMA\NR
            \NC 1 \MC 1.05 \lt s \NR
        \stopcases
    \stopformula

    where

    \startformula
        \RHL = \frac{\QTOT}{\QSAT} = \frac{\QVAP + \QLIQ}{\QSAT}
    \stopformula

    is the fraction of total water content to water content at saturation,
    a generalization of relative humidity that includes liquid water.
    Integration yields the desired expressions for liquid water content and
    specific humidity

    \placeformula
    \startformula
    \startalign[align={center,right}]
        \NC
        \QLIQ(\RHL) = \startcases[align={left,left,right}]
            \NC 0 \MC s \lt 0.95 \NR
            \NC \frac{\QSAT}{2} \left( \RHL - 0.95 - \frac{0.1}{\pi}
                \cos \left( \frac{\pi \RHL}{0.1} \right) \right)
                \MC 0.95 \le s \le 1.05 \NR
            \NC \QLIQ(1.05) + \QSAT (\RHL - 1.05) \MC 1.05 \lt s \NR
        \stopcases \NC \NR[eq:qliq]
    \stopalign
    \stopformula

    and

    \placeformula[eq:qvap]
    \startformula
        \QVAP(\RHL) = \QTOT(\RHL) - \QLIQ(\RHL) \EQSTOP
    \stopformula

    It is important to note that because temperature is critical for
    determination of the saturation value of humidity the introduction of this
    partion of water content results in a strong dependency of the humidity
    retrieval on the temperature retrieval \cite[authoryears][Bleisch2012]
    making it impossible to retrieve humidity independently of temperature.
    Another important consequence is that cloud water is intrinsically tied to
    relative humidity. The \cite[Karstens1994] cloud model used in this thesis
    assumes cloud liquid water exists wherever relative humidity exceeds 95 \%
    and but calculates the liquid water content independently of the specific
    value. The output of COSMO-7 used later to provide prior distributions for
    retrievals fixes relative humidity at 100 \% in all clouds. In both cases
    it happens that the particular combination of humidity and cloud water is
    not representable by the chosen partition. In practice both components are
    nevertheless added and any changes after separation are accepted due to
    there being a large uncertainty in the determination of cloud liquid water
    from the start (REF this).

    For optimal estimation retrievals there is an additional need to update
    pressure information after each iteration since pressure depends on
    temperature and humidity but is not part of the explicitly retrieved
    atmospheric state variables. Pressure is therefore calculated after each
    iteration by numerical integration of the hydrostatic equation

    \startformula
        p(z) = p(z_0) + \exp \left( - g \int_{z_0}^{z} \frac{1}{R(h) T(h)} \, \diff h \right) \EQSTOP
    \stopformula
    
    The errors of this approximation have been assessed by comparison with
    measured values of radiosonde ascents and are found to be neglible small.

\stopsection


\startsection[title={Retrieval Information Content and Weighting Functions}]

    Two important properties associated with atmospheric absorption govern the
    selection of frequencies at which a microwave radiometer measures in order
    to retrieve vertical profiles of thermodynamic variables. Because oxygen is
    a well mixed gas, its emission and absorption in the atmosphere does not
    depend on its mixing ratio but is directly proportional to local
    temperature. Water vapor amounts on the other hand vary strongly throughout
    the atmosphere but with temperature known, water vapor emission is
    proportional to its partial density \cite[Westwater2004]. These properties
    allow the retrieval of temperature an humidity. In order to obtain vertical
    profiles channels along the sides of the K and V band are observed. Because
    of the differently strong absorption each channel allows to looking
    differently far into the atmosphere \cite[authoryears][Churnside1994]. The
    actual information content does not scale with the number of channels since
    measurements at different positions of the same absorption band are not
    independent of one another \cite[authoryears][Hewison2006]. The use of
    multiple frequencies can be complemented by elevation scanning, discussed
    in section \in[ch:elevation_scanning].

    A common way to visualize the information content of a radiometer
    observation are the weighting functions, each one corresponding to
    a brightness temperature observation or rather simulation since weighting
    functions have to be obtained from a forward model. They are found by
    taking the derivative of the measured brightness temperature with respect
    to the atmospheric state vector. In the case of a vertically discretized
    atmosphere the weighting functions are the rows of the Jacobian of the
    forward model containing the derivatives with respect to each state vector
    element \cite[Rodgers2000]. Weighting functions are therefore a concept
    only applicable if the forward model can be linearly approximated.

    Because these functions have the same dimension as the atmospheric state
    vector they can conveniently be visualized on the retrieval grid. In this
    representation one can interpret the magnitude as the sensitivity of the
    measurement to the considered state vector component at the given height.
    Hence weighting functions can be used to assess from which heights in the
    atmosphere a radiometer channel obtains its information
    \cite[authoryears][Martinet2015]. In the optimal estimation framework the
    Jacobian is directly used in the inversion process with individual
    weighting functions acting somewhat similar to basis functions which
    determine where and at which scales the profile is modified during the
    retrieval. The functions' smoothness is therefore a limiting factor on
    details that can be recovered during the inversion. This highlights the
    importance of the first guess in the optimal estimation framework as its
    small scale features may be impossible to change during the retrieval if
    the weighting functions are too smooth.

    \placefigure[top][fig:jacobian_frequency]
        {Normalized weighting functions for the V band (left) and K band
        (right) channels of the HATPRO instrument (see section \in[ch:hatpro])
        simulated by the radiative transfer model introduced in section
        \in[ch:mwrtm] for an upwards looking view from an altitude of 612 m.
        The V band weighting functions are with respect to temperature, the
        K band weighting functions with respect to the natural logarithm of
        humidity. Lighter colors correspond to channels of higher frequency.
        The assumed atmospheric profile is the U.S. standard atmosphere with
        relative humidity decreasing from 70 \% at the surface to 10 \% at 11
        km above which it is constant.
        }
        {\externalfigure[jacobian_frequency][width=\textwidth]}

    Figure \in[fig:jacobian_frequency] shows weighting functions for HATPRO
    channels in the V band with respect to temperature and in the K band with
    respect to humidity. It can be seen that information originates mainly from
    the lower part of the troposphere. The larger diversity of temperature
    weighting functions compared to those of humidity indicates that the
    vertical resolution of temperature retrievals is generally better than for
    humidity retrievals \cite[authoryears][Cimini2011].

    TODO: calculation of Jacobian.
    Brute force: can be used with every model. Problems with selection of
    perturbations, non-linearity (e.g. at liquid water boundary). One-sided
    derivatives have bad accuracy (first order finite difference).  Possibility
    of truncating the Jacobian at upper levels to save computing time.

\stopsection


\startsection[title={Retrieval Grid},reference={}]
  
    TODO: Compromise between resolution and model runtime. Take some stuff from
    next section.

    Higher resolution does not mean that retrieval results in higher resolved
    features. Changes to the profile in iterative approach are goverened by the
    weighting functions, only features resolvable by this set of basis
    functions can effectively be removed or introduced to a retrieved profile
    (is this what Hewison talks about when he says the technique has problems
    with inversion displacement?). Important! Fine structure of first guess is
    likely preserved during retrieval. Smooth profiles likely better since they
    do not allow for missinterpretation of small scale features which are only
    an artefact of the initial value of the iterative scheme.

\stopsection


\startsection[title={Elevation Scanning},reference={ch:elevation_scanning}]

    Many radiometers are able to rotate their antenna in order to measure
    brightness temperatures at off-zenith angles, a procedure called elevation
    scanning. Changing the angle of measurement changes the associated
    weighting functions and therefore the region for which a channel is most
    sensitive. Figure \in[fig:jacobian_angle] shows weighting functions for
    two frequencies in the V band at different angles. When the zenith angle
    is larger, that is when the radiometer view is more horizontal, the
    weighting functions indicate higher sensitivity closer to the surface.
    Therefore elevation scanning is used to obtain additional information about
    and generally leads to more accurate retrievals in the boundary layer
    \cite[authoryears][Westwater2004] while the impact on retrieval performance
    at higher levels is only small \cite[authoryears][Cimini2006].
    \cite[Xu2014] remarked that due to the U-shape of the radomes used by many
    microwave radiometers measurements from elevation scans are less affected
    by rainwater accumulation on the instrument than those at zenith. This
    effect was also observed by \cite[Cimini2011] who noticed that off-zenith
    signals during precipitation were less noisy than zenith observations.

    \placefigure[top][fig:jacobian_angle]
        {Normalized weighting functions for 54.94 GHz (left) and 58.00 GHz
        (right) for different zenith angles simulated by the radiative transfer
        model introduced in section \in[ch:mwrtm]. The 0° weighting function
        for 0° (upward looking) is the  blue line, angles 60°, 65°, 70°, 75°,
        80°, 85° are the gray lines, with lighter colors being larger zenith
        angles. Atmospheric profile and radiometer location are the same as in
        Figure \in[fig:jacobian_frequency].
        }
        {\externalfigure[jacobian_angle][width=\textwidth]}

    The use of elevation scanning puts additional demands on the instrument,
    retrieval and radiative transfer model. In order to accurately observe
    brightness temperatures at large zenith angles, radiometers must be of high
    sensitivity. This is usually achieved by wide bandwidths of channels used
    at off-zenith angles \cite[authoryears][Cadeddu2002,Crewell2007]. Because
    an elevation scan needs more time than observations at a fixed angle
    a trade-off between temporal resolution and averaging time of a measurement
    is necessary \cite[authoryears][Cadeddu2002]. Measurements in transparent
    channels are very sensitive to the misalignment of angles
    \cite[authoryears][Hewison2006]. In complex terrain the radiometer view
    might end on a mountain slope and surface emission must be considered.
    Violations of the assumption of horizontal homogeneity are a major
    problem in elevation scanning as the likelihood that the radiometer
    view includes different air masses rises the more horizontal it is
    \cite[authoryears][Cimini2006]. This is also an issue in situations of
    inhomogeneous cloud cover \cite[authoryears][Guldner2013]. The effects may
    be reduced by scanning in multiple directions and averaging the
    measurements from same zenith angles though this additionally increases the
    time to make a measurement. \cite[Cimini2006] noticed a strong impact of
    horizontal inhomogeneity on neural network retrievals, likely due to the
    non-linearity of the method amplifying the associated variations in the
    brightness temperatures. \cite[Chan2010] used information from off-zenith
    angles only for the lowest levels of the atmosphere when retrieving
    humidity profiles by linear regression. For retrievals by optimal
    estimation, this is no issue since the weighting functions are explicitly
    included in the method.

    TODO: rewrite parts of this to fit into new section ordering
    In order to avoid many of the mentioned complications, transparent channels
    may be excluded in retrievals using elevation scan data and only the most
    opaque channels in the V band used at off-zenith angles
    \cite[alternative=authoryears,left={(e.g. }][Crewell2007,Massaro2015]. This
    is also done in the subsequent retrievals of this thesis although this
    decision is mainly governed by the radiative transfer model. Off-zenith
    light paths in the atmosphere are affected by refraction caused by density
    changes of the air and Earth's curvature must be taken into account
    \cite[authoryears][Hewison2006]. The radiative transfer model introduced in
    section \in[ch:mwrtm] currently does not take refraction into account which
    causes large errors in simulated brightness temperatures of transparent
    channels at off-zenith angles. Simulations of four opaque channels in the
    V band are nevertheless used. Due to paths lengths of light at these
    frequencies being very short
    \cite[alternative=authoryears,left={(300 - 2000 m, }][Crewell2007],
    refraction of light is negligible. This is also confirmed by a comparison
    of simulations with results from the reference model from section
    \in[ch:model_comparison] which shows differences considerably lower than
    the noise level of the radiometer.

\stopsection


\startsection[title={Characterization of Errors},reference={ch:rtm_errors}]

    Instrument random noise and forward model errors important for retrieval
    \cite[Caddedu2002]. Instrument noise of radiometers often assumed to be
    0.5 K and Gaussian \cite[Chu1994,Frate1998,Lohnert2004]

    Building part of the forward model covariance matrix.

    Compare exact Jacobian with brute force Jacobian.

    FAP errors: determine from climatology by comparison of exact
    calculations with FAP predictions.

    Discretization errors: deterine from climatology by comparing
    interpolated profiles with full resolution profiles.

    Bias correction important
    \cite[Turner2007,Turner2013,Lohnert2012,Guldner2013,Martinet2015] but
    \cite[Cimini2011] found this is not that beig an issue....

    Calibration of radiometer can cause jumps in retrieval performance due to
    bias changing \cite[Lohnert2012,Guldner2013].

    Uncertainty of RT is major limit on retrieval especially water
    vapor \cite[Cimini2004] and uncertainties in models can reach up to 4K in
    terms of brightness temperatures.

\stopsection


\startsection[title={Implementation of a Radiative Transfer Model Prototype},reference=ch:mwrtm]

    A numerical microwave radiative transfer model has been implemented as
    part of this thesis. It is based on the absorption models by
    \cite[Liebe1993] for gaseous absorption and \cite[Turner2016] for cloud
    liquid water absorption. The prototype's distinguishing features are its
    accessible implementation in a high-level, dynamic programming language
    (Python 3) and the calculation of temperature and humidity Jacobians by
    forward-mode automatic differentiation. Given an atmospheric profile of
    pressure, temperature and humidity, it first calculates absorption
    coefficients and then evaluates equation \ineq{rte_solution} numerically.
    The model will subsequently be referred to as MWRTM (MicroWave Radiative
    Transfer Model).

\startsubsection[title={Motivation}]

    It is not obvious why another implementation of a numerical radiative
    transfer model is attempted when established and freely available software
    such as MonoRTM \cite[authoryears][Clough2005] or ARTS
    \cite[authoryears][Buehler2005] exists. The development of a new model
    prototype is motivated by three aspects:

    Current RTMs either resort to expensive finite difference approaches when
    calculating Jacobians or use hand-crafted routines mixing analytically
    derived expressions and finite difference approximations where analytical
    expressions are unavailable. As examples, MonoRTM currently has no
    implementation of derivatives making finite differencing necessary while
    ARTS has specially written modules for calculating Jacobians. The rising
    interest in machine learning in recent years has lead to the widespread use
    of automatic differentiation, a method with which any numerical program can
    be differentiated to machine precision without the need to explicitly write
    code for the derivatives. This technique has proven its usefulness in
    machine learning models and is used in the radiative transfer model for the
    exact calculation of weighting functions.  Current radiative transfer
    models are written in statically typed, compiled languages such as Fortran
    or C++. Data analysis however is usually done in a high-level language such
    as Python. A question of interest is if it is computationally feasible to
    implement a RTM completely in a dynamic language. This would make the model
    code more accessible to the user and simplify the setup procedure. Finally
    there is a personal motivation of the author associated with the decision
    to implement a radiative transfer model. It is assumed that detailed
    knowledge of all implementation aspects and calculations will help with the
    overall understanding of retrievals and their results.

    It is not expected that the implementation attempt directly results in
    a perfect model. The expectation is rather to build a flexible, easy to
    understand, reasonably fast and adequately accurate prototype. The next
    sections discuss important aspects of development and evaluate the
    overall model performance.

\stopsubsection

\startsubsection[title=Numerical Considerations]

    In order to obtain numerically stable results the radiative transfer model
    has to operate internally with a much finer discretization than that of
    typical grids on which retrievals take place. Due to the generally greater
    changes of absorption and temperature with height in the lower troposphere,
    the internal model grid can be coarser at greater altitudes without losing
    accuracy.

    User has full control over internal model discretization, choice for
    subsequent retrievals is a logarithmically spaced grid.

    Input has to be interpolated to internal grid. First try was calculating
    absorption coefficients first and linearly interpolating those but this
    resulted in large errors. It was then decided to first interpolate
    pressure, temperature and humidity to the model grid and to calculate
    the absorption coefficients on the fine grid.

    Quadrature scheme: second order trapezoidal rule.
    
    Error covariance.

\stopsubsection

\startsubsection[title=Automatic Differentiation,reference=ch:autodiff]

    Interest in efficient and accurate computation of gradients has risen
    immensely in recent years due to its need during the training of many
    machine learning algorithms. The concept has been known at least since the
    1960s and been rediscovered multiple times since then
    \cite[authoryears][Griewank2012]. The need to efficiently calculate
    Jacobians of numerical models (often called adjoint modelling) is also
    a problem often encountered in atmospheric sciences. Data assimilation for
    numerical weather prediction models was one of the first applications of
    automatic differentiation \cite[authoryears][Griewank2012]. Despite that,
    the technique was mentioned only in one short paragraph modelling by
    \cite[Errico1997] in a review of adjoint models and even a modern radiative
    transfer model such as ARTS still has hand-written code for the calculation
    of Jacobians.

    At its core, automatic differentiation is nothing more than the application
    of the chain rule of differentiation to the computational graph of
    a program. It is not the same as symbolic differentiation though, which
    often requires significant effort and has the problem of combinatorial
    blowup of expressions. Instead, implementations of automatic
    differentiation are able to compute derivatives simultaneously with the
    forward code or in a second pass and a decent implementation has to visit
    each edge of the computational graph only once resulting in equal
    complexities of forward and Jacobian calculations. A short and good
    (although not peer-reviewed) explanation of the idea behind automatic
    differentiation is found at
    \hyphenatedurl{http://colah.github.io/posts/2015-08-Backprop}
    \footnote{last accessed 2016-07-25}.

    There are two ways of performing automatic differentiation, differentiated
    by the direction of traversal of the computational graph. The forward-mode
    moves from the input nodes towards the output, computing the derivatives
    with respect to each input variable along the way. Implementations of
    forward-mode automatic differentation are easy in programming languages
    supporting dispatch on types. Aside from replacing numeric variables with
    instances of a custom type with additional fields for the derivatives and
    overloading the usd operators and functions, only minor or no changes to
    the program at all are necessary. The reverse-mode moves from the output
    leafs toward the input nodes, computing the derivative of each output with
    respect to each node of the computational graph. Because the reverse-mode
    requires a second pass thorough the graph implementations need to keep
    track of intermediate results calculated in the first pass. Both techniques
    yield the same results but can be very different in terms of computational
    cost. Generally speaking, reverse-mode is suitable for problems with many
    inputs and only few outputs while the forward mode is more efficient for
    problems with more outputs than inputs.

    A radiative transfer model, with many atmospheric layers as input and only
    a few brightness temperatures as output is better suited for reverse-mode
    differentiation. The prototype here nevertheless uses the much easier to
    implement forward-mode. Transformation of the forward model code required
    a custom type, the overloading of a few operators and functions and minimal
    changes to the existing code. The only performance optimization made is
    a special consideration of derivatives associated with the calculation of
    the absorption coefficients on the internal model grid.

\stopsubsection

\startsubsection[title=Fast Absorption Prediction]

    The radiative transfer model spends the majority of its time calculating
    absorption coefficients. Although the models of \cite[Liebe1993] and
    \cite[Turner2016] are already fairly simple, it is convenient to replace
    them by a fast absorption predictor (FAP) in order to reduce the overall
    model computation time. FAPs are regression models of the absorption
    coefficient as a funcion of the state vector, trained on data representing
    typical atmospheric conditions. fast absorption predictors have previously
    been used by \cite[Lohnert2004], \cite[Hewison2006] and others.

    Following the choice of state vector variables from section
    \in[ch:statevector], the predictors are chosen to be pressure, temperature
    and the natural logarithm of total specific water content. A first
    implementation modelled both gaseous and cloud absorption together using a
    polynomial of the state vector variables. Even for polynomials of degree
    five including all interaction terms large errors were found in the
    approximated absorption coefficients. Investigation of this issue showed
    that the polynomial was unable to adequately represent the strong
    non-linearity of absorption near the cloud threshold. Polynomials of higher
    order are strongly affected by combinatorial blowup of interaction terms
    and numerical stability issues, therefore a more refined approach is taken.

    Instead of fitting a polynomial to the combined gaseous and cloud
    absorption the components are approximated separately after the total
    water content of the state vector has been separated into vapor and liquid
    components according to \ineq{qliq} and \ineq{qvap}. Specific cloud
    absorption following \cite[Turner2016] is only a function of temperature
    modelled by the FAP as a 5th order polynomial of temperature. Gaseous
    absorption depends on $p$, $T$ and $\QVAP$. \cite[Lohnert2004] and
    \cite[Hewison2006] used third order polynomials without interaction terms
    as FAPs and claimed good accuracy. Here it was found to be necessary to
    approximate absorption coefficients by polynomials including all
    interaction terms of third order for V band frequencies and fourth order
    for K band frequencies. The higher order polynomial for K band frequencies
    was found to be necessary to avoid negative absorption coefficients in the
    more opaque channels. Before it was also tested to model the logarithm of
    the absorption coefficient with an FAP to enforce positivity. Due to
    a negative impact on accuray, likely due to the additional non-linearity
    introduced by the transformation, this was not pursued further.

    Errors introduced by the FAPs are quantified in an error covariance matrix
    and included in the total forward model error. The matrix is determined
    from differences of simulations with and without fast absorption
    predictors.

\stopsubsection

\startsubsection[title={Model Comparison},reference={ch:model_comparison}]

    The model should be compared to established radiative transfer models to
    ensure its correctness. A model comparison also allows a quantification of
    spectroscopy errors which are an important part of the forward model error
    covariance (section \in[]) \cite[authoryears][Hewison2006]. Brightness
    temperature simulations from two other models are available for the
    evaluation: MonoRTM version 5.2 \cite[authoryears][Clough2005] and a model
    using gas absorption according to \cite[Rosenkranz1998] previously used by
    \cite[Massaro2015]. The test data set is made up of 1568 radiosonde
    profiles from Innsbruck. Because the data from \cite[Massaro2015] use
    a slightly different cloud liquid water parameterization than this thesis
    does (see section \in[ch:???]) and only spectroscopic errors should be
    assessed here all profiles of the test data set are clear sky cases.

    \placefigure[top][fig:model_comparison]
        {Mean difference (saturated) and covariance (pale) of brightness
        temperatures calculated by the model implemented in section
        \in[ch:mwrtm] (MWRTM), MonoRTM 5.2 and a model based on absorption
        as described by \cite[Rosenkranz1998] for over 1000 radiosonde ascents
        and zenith view. The covariances are sampled from the full covariance
        matrices.
        }
        {\externalfigure[model_comparison][width=\textwidth]}

    Figure \in[fig:model_comparison] shows the results of the model comparison
    in terms of mean and standard deviation of model differences. As noticed
    before by \cite[Westwater2004] and \cite[Cimini2004], the absorption models
    agree best in opaque spectral regions. Biases change sign between V and
    K band and their magnitude in the more transparent V band channels is
    generally higher than in the K band channels. Overall, MWRTM agrees better
    with MonoRTM than with Rosenkranz and MonoRTM and Rosenkranz agree better
    with each other than with MWRTM.

    Magnitudes of the bias values can be compared to a study by
    \cite[Cimini2004] who evaluated four absorption models including all of the
    ones used here (although they used an older version of MonoRTM).  Overall
    bias values on the order of 1 - 2 K are found in their comparison as well.
    In the K band their implementation of a RTM using \cite[Rosenkranz1998]
    absorption also showed better agreement with MonoRTM than with the
    \cite[Liebe1993] model. In the V band however agreement between absorption
    by \cite[Rosenkranz1998] and \cite[Liebe1993] is better than seen in Figure
    \in[fig:model_comparison] with a significantly smaller bias in the more
    transparent channels.

    TODO:
    \cite[Liebe1993] absorption verified by comparison to routines from
    \hyphenatedurl{http://reef.atmos.colostate.edu/~odell/at622/assignments/project1/codes/},
    no difference if exact absorption of FAP is used, no difference if internal
    model resolution is changed.
    Bias does not appear to scale with transparency of channel and changes sign
    between K and V band.
    Since comparison results are from zenith refraction cannot be cause of
    differences either.
    Differences must come from implementation details of the radiative transfer
    or differences in state representation.

    Also compare with \cite[Lohnert2004], figure 2.

    Elevation scanning.

    The spectroscopic error covariance matrix is assembled from the comparison
    with the model used by \cite[Massaro2015].

\stopsubsection

    
\startsubsection[title={Achievements and Shortcomings}]

    The implementation of MWRTM's automatic differentiation is rather crude and
    not extremely efficient. Nevertheless it showcases that the method is
    applicable to radiative transfer modelling and even though barely any
    performance optimizations were done, calculation of Jacobians is
    significantly faster than by finite differences. Future developments with
    automatic differentiation should apply one of the many available code
    generators, which make it easy to use backward-mode differentiation and
    exploit compiler optimizations for high efficiency.

    This discrepancy might require more investigation if
    the MWRTM is developed further but for the rest of this thesis it is still
    the model used for all retrievals. This is justified by the following
    arguments: Since there is no bias between the MWRTM and other models in
    the more opaque channels of the V band and the standard deviation between
    models is less than 1 K even for the transparent channels, it is unlikely
    that the source of this discrepancy is a fundamental error in the
    implementation of the \cite[Liebe1993] absorption model. A more likely
    source are different discretization, interpolation and numerical quadrature
    schemes between the model implementations or differences in the test data
    sets (the test data set of \cite[Cimini2004] contained only 34 profiles).
    In practice, when assessing the performance of synthetic retrievals,
    a model bias is irrelevant as long as the entire retrieval is affected by
    the same bias. In applications involving real radiometer measurements model
    biases are determined by a comparison between matching observations and
    model calculations and subsequently accounted for. The observed discrepancy
    will therefore have no effect on the retrieval performance investigated
    here.

\stopsubsection

\stopsection

