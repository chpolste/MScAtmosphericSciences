Numerical radiative transfer calculations play a central role in retrieval.
Iterative retrieval impossible without, statistical requires long history of
measurements and radiosondes, which is available at only very few locations in
the world and not transferrable (is that true???).

A few common model are used: MONORTM (which is the basis of the previous
retrieval studies from Innsbruck), MPM, ARTS, .... TODO: refer to comparison
study. Currently developed: RTTOV-gb, which appears to be very promising.
Older models such as MONORTM appear to be slowly left behind as more and more
authors start to use optimal estimation techniques. Instead mature and more
modern projects such as ARTS and now also RTTOV-gb, which provide analytical
Jacobians are favored (show this with citations).

In this chapter: presentation of the basics of radiative transfer, discussion
of discretization techniques, linearization and error characterization. The
chapter ends with a custom implementation of an RTM containing only the bare
essentials but providing exact Jacobians. The model is supposed to
be a demonstration prototype optimized for ease of use, not computational
performance or accuracy.


\startsection[title=The Radiative Transfer Equation]

    The differential form of the radiative transfer equation in
    a non-scattering medium is given by
    \cite[alternative=authoryears,left={(e.g. }][Buehler2005]

    \placeformula[eq:rte_general]
    \startformula
        \DERIV{I_\nu}{s} = - I_\nu \ABSCOEF + F
    \stopformula

    where $I_\nu$ is radiative power per frequency, solid angle and area in
    a specific direction (spectral radiance), $\ABSCOEF$ is the absorption
    coefficient of the medium, $F$ contains all sources of radiation and $s$ is
    distance in beam direction. The only source term considered here is the
    emission of the medium itself in thermal equilibrium according to Plank's
    law

    \startformula
        F = \epsilon \, B_\nu(T)
    \stopformula

    where $\epsilon$ is the emission coefficient of the grey body and
    $B_\nu(T)$ is the Planck function describing the emitted spectral radiance
    of a black body at a given temperature $T$. The emission coefficient
    quantifies the difference of the medium to a perfect black body as
    described by the Planck function and dependent on the considered frequency.
    Because thermodynamic equilibrium is assumed Kirchhoff's law allows to
    equal the absorption and emission coefficients of the medium

    \startformula
        0 \le \ABSCOEF = \epsilon \le 1
    \stopformula

    Substituting the results of Plank's law and Kirchhoff's law into the
    radiative transfer equation \ineq{rte_general} yields

    \startformula
        \DERIV{I_\nu}{s} = - \ABSCOEF(I_\nu - B_\nu(T)) \EQSTOP
    \stopformula

    For temperatures occuring in the atmosphere and the spectral region of
    microwave radiation the Planck function $B_\nu (T)$ is approximated
    well by the Rayleigh-Jeans approximation which relates the spectral
    radiance at a given frequency linearly to temperature $T$

    \startformula
        B_\nu(T) \approx \frac{2 \nu^2 k T}{c^2}
    \stopformula

    where $c$ is the speed of light and $k$ is the Boltzmann constant.
    Microwave radiometers measure brightness temperatures instead of spectral
    radiances. Brightness temperature $\BT$ is the temperature of a black body
    that emits the same spectral radiance as an observed grey body. In the
    Rayleigh-Jeans limit the relationship between temperature and brightness
    temperature is particularly simple: $\BT = \epsilon T$. Expressing
    observed spectral radiance in terms of Planck emission and again
    applying the Rayleigh-Jeans approximation

    \startformula
        I_\nu := \epsilon \, B_\nu(T)
            \approx \epsilon \, \frac{2 \nu^2 k T}{c^2}
            = \frac{2 \nu^2 k}{c^2} \, \BT \EQCOMMA
    \stopformula

    and noting that the term $\frac{2 \nu^2 k}{c^2}$ is constant for a
    fixed frequency, the radiative transfer equation \ineq{rte_general} for
    a given frequency can be expressed exclusively in terms of temperature and
    brightness temperature

    \placeformula[eq:rte_radiometer]
    \startformula
        \DERIV{\BT}{s} = - \ABSCOEF (\BT - T) \EQSTOP
    \stopformula

    Because $T = T(s)$, analytical solutions of equation \ineq{rte_radiometer}
    can only be found in a few special cases and numerical solutions have to
    be seeked in general.

\stopsection


\startsection[title={A Solution for Ground-based Radiometer Applications}]

    For a radiometer looking up or at an angle to the side from the surface the
    absorbing and emitting medium is the atmosphere. To simulate a radiometer
    measurement by solving the radiative transfer equation, the atmospheric
    state has to be projected onto the light path observed by the radiometer.
    Since atmospheric state is usually known as a function of altitude the
    first step towards a solution of \ineq{rte_radiometer} is a coordinate
    transform into height coordinates

    \startformula
        \DERIV{s}{z} = - \frac{1}{\cos(\theta)} \EQSTOP
    \stopformula

    $z$ is the altitude coordinate and $\theta$ the zenith angle describing the
    deviation of the radiometers viewing direction from zenith. Because $z$
    increases with height but $s$ is the distance along the light path which
    points downward (the observed radiation is downwelling), $\DERIV{s}{z}$
    must be negative. It is convenient for the solution of
    \ineq{rte_radiometer} to introduce optical depth

    \startformula
    \startalign[n=3,align={left,right,left}]
        \NC \NC \OD(s) := \NC \int_{s_0}^{s} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \OD(z) = \NC
            - \frac{1}{\cos(\theta)} \int_{z_0}^{z} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \DERIV{\OD}{z} = \NC
            - \frac{\ABSCOEF}{\cos(\theta)} \EQSTOP \NR
    \stopalign
    \stopformula

    Applying the coordinate transformation to \ineq{rte_radiometer},
    multiplying by $e^{\OD}$ and applying the chain and product rule of
    differentiation yields

    \startformula
        \DERIV{\BT}{z} e^\OD + \frac{\ABSCOEF \BT e^\OD}{\cos(\theta)}
        = \DERIV{(\BT e^\OD)}{z}
        = - \frac{\ABSCOEF T e^\OD}{\cos(\theta)} \EQSTOP
    \stopformula

    Integrating this differential equation from the surface ($z = 0$) to space
    ($z = \infty$) gives an expression for the brightness temperature observed
    by the (virtual) radiometer

    \placeformula[eq:rte_solution]
    \startformula
        \BT(0) = \BT(\infty) e^{\OD(\infty)} + \frac{1}{\cos(\theta)}
            \int_{0}^{\infty} \ABSCOEF(z) T(z) e^{\OD(z)} \diff z \EQSTOP
    \stopformula

    $T_B(\infty)$ is the brightness temperature of the cosmic background
    radiation which has a value of approximately 2.75 K for frequencies in the
    microwave spectrum \cite[authoryears][Westwater2004]. It is important to
    note that \ineq{rte_solution} is only valid at off-zenith angles if the
    vertical profiles of $T$ and $\ABSCOEF$ are horizontally homogeneous and if
    refraction of light and Earth's curvature are neglected. These restrictions
    are further discussed in section \in[ch:elevation_scanning].

\stopsection


\startsection[title=Atmospheric Extinction]

    \placefigure[top][fig:absorption]
        {Absorption coefficients (black) and contributions of individual terms
        (other) according to the models of \cite[Liebe1993] (gaseous) and
        \cite[Turner2016] (cloud) for a atmospheric layer at 850 hPa pressure,
        0°C temperature and saturation, containing 0.1 g/kg of liquid water.
        The arrows mark HATPRO channels.
        }
        {\externalfigure[absorption][width=\textwidth]}

    Westwater2004 used al lot, maybe cite once as main reference?

    Microwave region 20 - 200 GHz Main contributions to absorption of microwave
    radiation by oxygen and water vapor, which have rotational and vibrational
    transitions, and liquid water, whose apsorption can be treated with the
    Rayleigh-approximation.  Other effects include pressure-broadening,
    self-broadening, non-resonant continuum absorption.

    Water vapor: weak absorption at 22.235 (K band), strong line at 183.31 (not
    used here), also continuum absorption. Emission is proportional to water
    vapor density.  \cite[Westwater2004]

    Oxygen: absorption band between 50 and 70 GHz (V band) due to dipole
    transitions. Isolated line at 118, pressure broadening. Emission prop to
    local temperature, oxygen well mixed in the atmosphere.
    \cite[Westwater2004]

    Liquid water: cloud droplets small so that scattering can be neglected and
    Rayleigh approximation be used e.g. \cite[Westwater2004]. Then size
    distribution not needed. Rain droplets big enough so that this
    approximation is no longer valid, nevertheless retrievals in precipitation
    have been done. Problem also accumulation of rainwater on radome. Cloud
    absorption has stronger effect on weaker H2O band than oxygen absorption
    (also figure). Ice content can be neglected as it does not affect microwave
    radiation substantially e.g. \cite[Sanchez2013].

    Additional contributions to gaseous absorption by minor species such as N2
    (and CO2) \cite[Hewison2006] which contribute to broadening of other lines
    (check if true). All well mixed.

    Size of molecules and cloud particles too small for effective scattering
    therefore only absorption is considered in microwave region. Only at
    droplet sizes occuring during precipitation does scattering become
    important, these cases are problematic due to little knowledge of acutal
    LWC and droplet size distributions.

    Rasos do not measure CLW, therefore (semi-)empirical cloud models are used.
    Popular: \cite[Karstens1994]. Other authors have used fixed amounts based
    on local measurements (REF some chinese paper, Tan11?). \cite[Tan2011]
    found that impact of cloud liquid water on chosen cloud liquid amount is
    not monotonic (read again).

    Selection of radiometer channels according to information content.
    Measuring at different positions of an absorption band gives altitude
    information \cite[Westwater2004,Churnside1994]. But information content is
    limited by correlation between frequencies, channels are not independent.
    Other influence on channel selection for optimal estimation: fulfilment of
    Gaussian assumption \cite[Martinet2015].

    Multiple absorption models exist in the literature (e.g. Rosenkranz, Liebe,
    MONORTM which is based on HITRAN or similar?). These usually describe
    the most important lines, correct for the missing ones and parameterize
    the continuum. Cloud absorption is parameterized by a double-Debey model.
    Models are formulated in terms of refractivity $N$ (which is complex
    refractive index minus 1), absorption can be calculated by (REFERENCE?)

    \startformula
        \ABSCOEF = \frac{4 \pi \nu}{c}~ {\rm Im}(N) \EQCOMMA
    \stopformula

    where $c$ is the speed of light and $\nu$ is frequency.

    Here model by \cite[Liebe1993], containing ??? lines ..., is used to
    calculate absorption coefficients of gaseous absorption and model by
    \cite[Turner2016] for cloud liquid water absorption.

    Example of absorption in typical atmospheric conditions shown in Figure
    REF. Selecting frequencies along the sides of the absorption complexes
    of oxygen (V band) and water vapor (K band) allows profiling of the
    atmosphere as radiation at each frequency is differently absorbed along the
    way.

    RTMs built on top of these absorption models agree best in high absorbing
    spectral regions \cite[Westwater2004], weaker lines like water vapor allow
    looking further into atmosphere but deeper penetration also means more
    uncertainty. Uncertainty of RT is major limit on retrieval especially water
    vapor \cite[Cimini2004] and uncertainties in models can reach up to 4K in
    terms of brightness temperatures.

\stopsection


\startsection[title={Choice of State Vector Variables},reference={ch:statevector}]

    In order to determine atmospheric emission and absorption, the atmospheric
    state has to be represented somehow on the retrieval grid. Naively one
    would directly choose the quantites that are to be retrieved as state
    vector variables and this approach can work reasonably well for regression
    retrievals. Any method that makes the assumption of Gaussian distributed
    state vector variables however might require variable transformations to
    fulfil this requirement. For optimal estimation retrievals it is common to
    combine water vapor and liquid water into a single quantity and retrieve
    the logarithm of this quantity \cite[alternative=authoryears,left={(e.g.
    }][Lohnert2004,Hewison2006,Cimini2011]. Figure \in[fig:gauss_verification]
    shows the benefits of using the logarithm of humidity on the example of
    the climatological distribution at a single altitude: while temperatures in
    the atmosphere generally follow a Gaussian shape, humidity\footnote{In this
    case specific humidity but the same applies to water vapor density
    (absolute humidity) and relative humidity} is a positive variable and
    therefore not symmetrically distributed. Using its logarithm enforces
    positivity of values and reduces the skewness of the distribution, bringing
    it closer to a Gaussian shape.

    \placefigure[top][fig:gauss_verification]
        {Histograms of temperature (left), specific humidity (center) and
        the natural logarithm of specific humidity (right) for the 1339 m
        level of the radiosonde dataset (section \in[]).
        }
        {\externalfigure[gauss_verification][width=\textwidth]}

    Reducing water vapor and liquid water to a combined total water content
    variable is practical in multiple ways. In terms of the distribution
    functions the asymmetry found for liquid water content is even worse than
    for water vapor since many atmospheric profiles are cloud-free resulting
    in a mode at zero. Because the logarithm is not defined at zero a variable
    transformation does not help. Since there always is some water vapor in the
    atmosphere this mathematical problem is avoided by adding both components
    of water content and then applying the logarithm transformation. Another
    advantage of the combined variable is the reduction of state vector
    dimensionality resulting in smaller Jacobians and computationally faster
    optimal estimation retrievals. Of course the combination is only sensible
    if there is a way to separate the components again for the calculation of
    absorption coefficients.

    Ice negligible (section ???) therefore only vapor and liquid must be
    separated. Saturation vapor pressure function of temperature only making it
    possible to calculate the separation threshold using known quanties of the
    atmospheric state. In order to achive differentiability the partition
    function has a transition region starting at 95 \% relative humidity. This
    partition function approach has been previously employed by
    \cite[Hewison2006] and \cite[Deblonde]. The chosen form here is

    \startformula
        \DERIV{\QLIQ}{\RHL} = \QSAT \startcases
            \NC 0 \MC s \lt 0.95 \NR
            \NC \cos \left( \frac{\RHL - 1.05}{0.1} \frac{\pi}{2} \right)^2
                \MC 0.95 \le s \le 1.05 \EQCOMMA\NR
            \NC 1 \MC 1.05 \lt s \NR
        \stopcases
    \stopformula

    where

    \startformula
        \RHL = \frac{\QTOT}{\QSAT} = \frac{\QVAP + \QLIQ}{\QSAT}
    \stopformula

    is the fraction of total water content to water content at saturation,
    a generalization of relative humidity that includes liquid water.
    Integration yields the desired expressions for liquid water content and
    specific humidity

    \startformula
        \QLIQ(\RHL) = \startcases
            \NC 0 \MC s \lt 0.95 \NR
            \NC \frac{\QSAT}{2} \left( \RHL - 0.95 - \frac{0.1}{\pi}
                \cos \left( \frac{\pi \RHL}{0.1} \right) \right)
                \MC 0.95 \le s \le 1.05 \NR
            \NC \QLIQ(1.05) + \QSAT (\RHL - 1.05) \MC 1.05 \lt s \NR
        \stopcases
    \stopformula

    and

    \startformula
        \QVAP(\RHL) = \QTOT(\RHL) - \QLIQ(\RHL) \EQSTOP
    \stopformula

    It is important to note that because temperature is critical for
    determination of the saturation value of humidity the introduction of this
    partion of water content results in a strong dependency of the humidity
    retrieval on the temperature retrieval \cite[authoryears][Bleisch2012]
    making it impossible to retrieve humidity independently of temperature.
    Another important consequence is that cloud water is intrinsically tied to
    relative humidity. The \cite[Karstens1994] cloud model used in this thesis
    assumes cloud liquid water exists wherever relative humidity exceeds 95 \%
    and but calculates the liquid water content independently of the specific
    value. The output of COSMO-7 used later to provide prior distributions for
    retrievals fixes relative humidity at 100 \% in all clouds. In both cases
    it happens that the particular combination of humidity and cloud water is
    not representable by the chosen partition. In practice both components are
    nevertheless added and any changes after separation are accepted due to
    there being a large uncertainty in the determination of cloud liquid water
    from the start (REF this).

    For optimal estimation retrievals there is an additional need to update
    pressure information after each iteration since pressure depends on
    temperature and humidity but is not part of the explicitly retrieved
    atmospheric state variables. Pressure is therefore calculated after each
    iteration by numerical integration of the hydrostatic equation

    \startformula
        p(z) = p(z_0) + \exp \left( - g \int_{z_0}^{z} \frac{1}{R(h) T(h)} \, \diff h \right) \EQSTOP
    \stopformula
    
    The errors of this approximation have been assessed by comparison with
    measured values of radiosonde ascents and are found to be neglible small.

\stopsection


\startsection[title=Weighting Functions]

    A common way to analyze the information content of a radiometer measurement
    is calculating the weighting functions, each one corresponding to one
    brightness temperature observation or rather simulation since weighting
    functions have to be obtained from a forward model. They are found by
    taking the derivative of the measured brightness temperature with respect
    to the atmospheric state vector. In the case of a vertically discretized
    atmosphere the weighting functions are the rows of the Jacobian of the
    forward model containing the derivatives with respect to each state vector
    element \cite[Rodgers2000]. Weighting functions are therefore a concept
    only applicable if the forward model can be linearly approximated.

    Because these functions have the same dimension as the atmospheric state
    vector they can conveniently be visualized on the retrieval grid. In this
    representation one can interpret the magnitude as the sensitivity of the
    measurement to the considered state vector component at the given height.
    Hence weighting functions can be used to assess from which heights in the
    atmosphere a radiometer channel obtains its information
    \cite[authoryears][Martinet2015]. In the optimal estimation framework the
    Jacobian is directly used in the inversion process with individual
    weighting functions acting somewhat similar to basis functions which
    determine where and at which scales the profile is modified during the
    retrieval. The functions' smoothness is therefore a limiting factor on
    details that can be recovered during the inversion. This highlights the
    importance of the first guess in the optimal estimation framework as its
    small scale features may be impossible to change during the retrieval if
    the weighting functions are too smooth.

    \placefigure[top][fig:jacobian_frequency]
        {Normalized weighting functions for the V band (left) and K band
        (right) channels of the HATPRO instrument (see section \in[ch:hatpro])
        simulated by the radiative transfer model introduced in section
        \in[ch:mwrtm] for an upwards looking view from an altitude of 612 m.
        The V band weighting functions are with respect to temperature, the
        K band weighting functions with respect to the natural logarithm of
        humidity. Lighter colors correspond to channels of higher frequency.
        The assumed atmospheric profile is the U.S. standard atmosphere with
        relative humidity decreasing from 70 \% at the surface to 10 \% at 11
        km above which it is constant.
        }
        {\externalfigure[jacobian_frequency][width=\textwidth]}

    Figure \in[fig:jacobian_frequency] shows weighting functions for HATPRO
    channels in the V band with respect to temperature and in the K band with
    respect to humidity. It can be seen that information originates mainly from
    the lower part of the troposphere. The larger diversity of temperature
    weighting functions compared to those of humidity indicates that the
    resolution of temperature retrievals is generally better than for humidity
    retrievals \cite[authoryears][Cimini2011].

\stopsection


\startsection[title={Implementation of a Numerical Model Prototype},reference=ch:mwrtm]

    Presentation of a custom implementation of a line-by-line model. Based on
    absorption models by \cite[Liebe1993] for gaseous absorption and
    \cite[Turner2016] for cloud liquid water absorption. It features complete
    forward-mode automatic differentiation with respect to temperature and
    humidity. Jacobians can therefore be calculated exactly and relatively
    quick. The following sections expand on the individual aspects of this
    model, describe challenges of implementation and evaluate the model
    performance including the determination of the model's error covariance
    matrix for the Bayesian retrieval.

    \startsubsection[title={Motivation}]

        With existing models for radiative transfer, why build another one?
        Driven by the question if a specialized model, stripped down to its
        bare essentials can perform similarly well as full featured models such
        as MonoRTM or ARTS. Hope for better convergence properties if exact
        Jacobians are available. ARTS (and the not yet available RTTOV-gb)
        provides linearizations but is quite heavy machinery.

        Learning experience, understanding by doing. Knowing each component of
        the retrieval method well should help overall understanding of results.
        
        Implementation completely in a high-level language allows easy
        integration of model with other data analysis, quick setup and rapid
        development of new features in the future. Thanks to numpy it is still
        relatively fast.

        Expected is a somewhat worse model performance than reference models
        such as MONORTM (against which it will be compared). Suspected main
        contributor of errors: Bending due to changing refractive index
        neglected. This affects all angles away from zenith. 

        TODO: hint at MonoRTM comparison, is it really that bad, what about
        sensitivity mostly in lower atmosphere? Besides, forward model errors
        are accounted for in Bayesian approach, this error should appear in
        MONORTM/MWRTM cov matrix.
        
    \stopsubsection

    \startsubsection[title=Discretization and Interpolation]

        Smoothing: interpolation scheme is very important and might affect the
        resulting brightness temperatures calculated by the model. Proposed
        discretizations: add levels dynamically to keep all extrema, this is
        good for inversion situations but only applicable if the regions with
        problematic values are known beforehand, which is not the case for
        real-time retrievals. When NWP model is used for a-priori, it is
        convenient to use the model grid, but impossible for stations like
        Innsbruck where model topography often ends much higher up than
        actual location of instrument. Generally it is desirable to have higher
        resolution in the lower atmosphere, where more stuff happens and
        at which heights the model has high sensitivity, so numerical errors
        should be kept as small as possible.

        Compromise between resolution necessary for numerical model (as many
        levels as possible) and actual information content (only few levels).
        More levels are more expensive to calculate. Inclusion of upper
        atmosphere or not.

        Levels in input atmospheric state determine size of Jacobian and
        therefore also computational cost. Higher resolution does not mean
        that retrieval results in higher resolved features. Changes to the
        profile in iterative approach are goverened by the weighting functions,
        only features resolvable by this set of basis functions can effectively
        be removed or introduced to a retrieved profile (is this what Hewison
        talks about when he says the technique has problems with inversion
        displacement?). Important! Fine structure of first guess is likely
        preserved during retrieval. Smooth profiles likely better since they
        do not allow for missinterpretation of small scale features which are
        only an artefact of the initial value of the iterative scheme.

        Numerical discretization very important for accurate results, high
        vertical resolution especially in the lower troposphere is required to
        obtain accurate numerical results.

    \stopsubsection

    \startsubsection[title=Fast Absorption Prediction]

        A major part of the radiative transfer calculations is the determination of
        the absorption coefficient of each layer of the discretization. Although
        the models of \cite[Liebe1993] and \cite[Turner2016] are already fairly
        simple, the forward model spends a large fraction of computing time in
        these components. The purpose of a \infull{FAP} (\FAP) is to reduce this
        time. It also simplifies the task of model linearization greatly
        (section \in[ch:linearization]). The {\FAP} is chosen to be a polynomial of
        the state vector variables $p$, $T$, $\LNQ$ (although with some prior
        processing of the variables, as seen shortly). The polynomial coefficients
        are determined by multiple linear regression.
        
        In a first implementation both gaseous and cloud absorption were modelled
        together by a single polynomial of the state vector variables. Up to
        polynomials of degree 5 yielded large errors in the approximated absorption
        coefficients. The polynomial was not able to adequately represent the
        strong nonlinearity at the cloud threshold. Higher order polynomials are
        affected by combinatorial blowup of interaction terms and numerical
        stability, therefore a more refined approach is taken.

        Instead of fitting a polynomial to the combined gaseous and cloud
        absorption, the components are approximated separately. Specific cloud
        absorption according to the model by \cite[Turner2016] is only a function
        of temperature. A 5th order polynomial in $T$ is sufficient to approximate
        cloud absorption at a selected frequency with good accuracy. The gaseous
        absorption is modelled by $p$, $T$ and $\QVAP$, with the latter obtained by
        separating $\QTOT$ into its vapor and liquid components using ???).
        \cite[Lohnert2004] and \cite[Hewison2006] used a third order polynomial of
        these variables without interaction terms and claimed good accuracy. This
        was not observed here, therefore a 5th order polynomial with all
        interaction terms is used in this work. Additionally, instead of using the
        absorption coefficient $\ABSCOEF$ as the target of the regression directly,
        $\ln(\ABSCOEF)$ is used in order to guarantee positivity of the
        approximated $\ABSCOEF$.

        TODO: describe test data set. FAP scpecialized for each frequency.
        Evaluate FAP performance for each line of the HATPRO. Training data:
        synthetic gridded data representative for a wide variety of atmospheric
        states. Climatology is test dataset. Climatology is not used for training
        due to profiles being mostly at night and night, therefore temperatures are
        not representative of whole range of realistic values. Climatology is
        valuable as independent test set. Mention that FAP errors contribute to
        covariance matrix.

    \stopsubsection

    \startsubsection[title=Linearization,reference=ch:linearization]

        Necessary for iterative optimal estimation approach but also gives
        information about the sensitivity of the measurement to different layers of
        the atmosphere (weighting functions). Quality of linearization important
        for convergence of iterative retrieval procedure. Literature review:
        everyone seems to be working with finite differences, but often complaints
        that these calculations take long. ARTS offers approximated Jacobians
        but with a model reduced to the essentials it is possible to evaluate the
        Jacobian exactly and this is done here.

        Brute force: can be used with every model. Problems with selection of
        perturbations, non-linearity (e.g. at liquid water boundary). One-sided
        derivatives have bad accuracy (first order finite difference).
        Possibility of truncating the Jacobian at upper levels to save
        computing time.

        Analytical alternatives to finite differences: symbolic and automatic
        differentiation. Symbolic differentiation often requires significant
        effort and has the problem of combinatorial blowup of expressions.
        Automatic differentiation evaluates the derivatives at each node of
        the computation graph directly. There are two ways of performing
        automatic differentiation: the forward-mode type moves from the input
        towards the output, computing the derivatives with respect to each
        input along the way. The reverse-model type moves from the output
        towards the input, computing the derivative of each output with respect
        to each node of the computation graph along the way. Both techniques
        yield the same results but might be very different in terms of
        computational cost. Generally speaking reverse-mode is suitable for
        problems with many inputs and only few outputs, while forward mode
        differentiation is more efficient for problems with more outputs than
        inputs.

        A radiative transfer model, with many atmospheric layers and only
        a few brightness temperatures as output seems well suited for
        reverse-model differentiation. The model presented in the next section
        uses forward mode despite that due to it being more easy to implement
        and due to the merging of computational paths only happening at the end
        of the model calculation and having little interaction in between
        (absorption coefficients are only dependend on their own layer),
        therefore the computational advantage of reverse-mode is likely to be
        offset by the more complicated implementation.

        TODO: mention that there are code generators for automatic
        differentiation, tie in backprop if NNs are used and maybe make a
        computational graph for the model, showing that most of the model
        happens in parallel.

    \stopsubsection


\stopsection


\startsection[title={Characterization of Errors},reference={ch:rtm_errors}]

    Instrument random noise and forward model errors important for retrieval
    \cite[Caddedu2002]. Instrument noise of radiometers often assumed to be
    0.5 K and Gaussian \cite[Chu1994,Frate1998,Lohnert2004]

    Building part of the forward model covariance matrix.

    Compare exact Jacobian with brute force Jacobian.

    FAP errors: determine from climatology by comparison of exact
    calculations with FAP predictions.

    Discretization errors: deterine from climatology by comparing
    interpolated profiles with full resolution profiles.

    Bias correction important
    \cite[Turner2007,Turner2013,Lohnert2012,Guldner2013,Martinet2015] but
    \cite[Cimini2011] found this is not that beig an issue....

    Calibration of radiometer can cause jumps in retrieval performance due to
    bias changing \cite[Lohnert2012,Guldner2013].

\stopsection


\startsection[title={Model Comparison},reference={ch:model_comparison}]

    \placefigure[top][fig:model_comparison]
        {Mean difference (saturated) and covariance (pale) of brightness
        temperatures calculated by the model implemented in section
        \in[ch:mwrtm] (MWRTM), MonoRTM 5.2 and a model based on absorption
        as described by \cite[Rosenkranz1998] for over 1000 radiosonde ascents
        and zenith view. The covariances are sampled from the full covariance
        matrices.
        }
        {\externalfigure[model_comparison][width=\textwidth]}

    Need arises for quantification of spectral errors as seen in the previous
    chapter. Refer to comparison study.

    Compare Figure \in[fig:model_comparison] with results from \cite[Cimini2004]

    Existing dataset from Massaro/Meyer, using Rosenkranz absorption etc.

    Implementation of a MonoRTM wrapper. Short description of MonoRTM,
    reference ARM models, version 5.2.

    Clouds vs. elevation scanning. \cite[Blumberg2015] used MonoRTM version 4.2
    at different elevation angles. It is unclear how they managed this.

\stopsection


\startsection[title={[Elevation Scanning},reference={ch:elevation_scanning}]

    Many radiometers are able to rotate their antenna in order to measure
    brightness temperatures at off-zenith angles, a procedure called elevation
    scanning. Changing the angle of measurement changes the associated
    weighting functions and therefore the region for which a channel is most
    sensitive. Figure \in[fig:jacobian_angle] shows weighting functions for
    two frequencies in the V band at different angles. When the zenith angle
    is larger, that is when the radiometer view is more horizontal, the
    weighting functions indicate higher sensitivity closer to the surface.
    Therefore elevation scanning is used to obtain additional information about
    and generally leads to more accurate retrievals in the boundary layer
    \cite[authoryears][Westwater2004] while the impact on retrieval performance
    at higher levels is only small \cite[authoryears][Cimini2006].
    \cite[Xu2014] remarked that due to the U-shape of the radomes used by many
    microwave radiometers measurements from elevation scans are less affected
    by rainwater accumulation on the instrument than those at zenith. This
    effect was also observed by \cite[Cimini2011] who noticed that off-zenith
    signals during precipitation were less noisy than zenith observations.

    \placefigure[top][fig:jacobian_angle]
        {Normalized weighting functions for 54.94 GHz (left) and 58.00 GHz
        (right) for different zenith angles simulated by the radiative transfer
        model introduced in section \in[ch:mwrtm]. The 0° weighting function
        for 0° (upward looking) is the  blue line, angles 60°, 65°, 70°, 75°,
        80°, 85° are the gray lines, with lighter colors being larger zenith
        angles. Atmospheric profile and radiometer location are the same as in
        Figure \in[fig:jacobian_frequency].
        }
        {\externalfigure[jacobian_angle][width=\textwidth]}

    The use of elevation scanning puts additional demands on the instrument,
    retrieval and radiative transfer model. In order to accurately observe
    brightness temperatures at large zenith angles, radiometers must be of high
    sensitivity. This is usually achieved by wide bandwidths of channels used
    at off-zenith angles \cite[authoryears][Cadeddu2002,Crewell2007]. Because
    an elevation scan needs more time than observations at a fixed angle
    a trade-off between temporal resolution and averaging time of a measurement
    is necessary \cite[authoryears][Cadeddu2002]. Measurements in transparent
    channels are very sensitive to the misalignment of angles
    \cite[authoryears][Hewison2006]. In complex terrain the radiometer view
    might end on a mountain slope and surface emission must be considered.
    Violations of the assumption of horizontal homogeneity are a major
    problem in elevation scanning as the likelihood that the radiometer
    view includes different air masses rises the more horizontal it is
    \cite[authoryears][Cimini2006]. This is also an issue in situations of
    inhomogeneous cloud cover \cite[authoryears][Guldner2013]. The effects may
    be reduced by scanning in multiple directions and averaging the
    measurements from same zenith angles though this additionally increases the
    time to make a measurement. \cite[Cimini2006] noticed a strong impact of
    horizontal inhomogeneity on neural network retrievals, likely due to the
    non-linearity of the method amplifying the associated variations in the
    brightness temperatures. \cite[Chan2010] used information from off-zenith
    angles only for the lowest levels of the atmosphere when retrieving
    humidity profiles by linear regression. For retrievals by optimal
    estimation, this is no issue since the weighting functions are explicitly
    included in the method.

    In order to avoid many of the mentioned complications, transparent channels
    may be excluded in retrievals using elevation scan data and only the most
    opaque channels in the V band used at off-zenith angles
    \cite[alternative=authoryears,left={(e.g. }][Crewell2007,Massaro2015]. This
    is also done in the subsequent retrievals of this thesis although this
    decision is mainly governed by the radiative transfer model. Off-zenith
    light paths in the atmosphere are affected by refraction caused by density
    changes of the air and Earth's curvature must be taken into account
    \cite[authoryears][Hewison2006]. The radiative transfer model introduced in
    section \in[ch:mwrtm] currently does not take refraction into account which
    causes large errors in simulated brightness temperatures of transparent
    channels at off-zenith angles. Simulations of four opaque channels in the
    V band are nevertheless used. Due to paths lengths of light at these
    frequencies being very short
    \cite[alternative=authoryears,left={(300 - 2000 m, }][Crewell2007],
    refraction of light is negligible. This is also confirmed by a comparison
    of simulations with results from the reference model from section
    \in[ch:model_comparison] which shows differences considerably lower than
    the noise level of the radiometer.

\stopsection

