Numerical radiative transfer calculations play a central role in retrieval.
Iterative retrieval impossible without, statistical requires long history of
measurements and radiosondes, which is available at only very few locations in
the world and not transferrable (is that true???).

A few common model are used: MONORTM (which is the basis of the previous
retrieval studies from Innsbruck), MPM, ARTS, .... TODO: refer to comparison
study. Currently developed: RTTOV-gb, which appears to be very promising.
Older models such as MONORTM appear to be slowly left behind as more and more
authors start to use optimal estimation techniques. Instead mature and more
modern projects such as ARTS and now also RTTOV-gb, which provide analytical
Jacobians are favored (show this with citations).

In this chapter: presentation of the basics of radiative transfer, discussion
of discretization techniques, linearization and error characterization. The
chapter ends with a custom implementation of an RTM containing only the bare
essentials but providing exact Jacobians. The model is supposed to
be a demonstration prototype optimized for ease of use, not computational
performance or accuracy.


\startsection[title=The Radiative Transfer Equation]

    General form, absorption only, Rayleigh-Jeans → Brightness Temperatures.
    Discretization.

    Differential form of RTE without scattering

    \startformula
        \DERIV{I_\nu}{s} = - I_\nu \ABSCOEF + F \EQCOMMA
    \stopformula

    where $I_\nu$ is spectral radiance (power per frequency and solid angle in
    a specific direction), $\ABSCOEF$ is the absorption coefficient of the medium
    ($0 \lt \ABSCOEF \lt 1$), $F$ is a source term and $s$ is distance in beam
    direction.

    The only source term considered here is emission according to Planck's law

    \startformula
        F = \epsilon B_\nu(T) \EQCOMMA
    \stopformula

    where $\epsilon$ is the emission coefficient of the radiating medium
    describing its difference to an ideal black body ($0 \lt \epsilon \lt 1$)
    and $B_\nu(T)$ is the Planck function giving the emitted spectral radiance
    of a black body. Under the assumption of thermodynamic equilibrium the
    absorption and emission coefficients are equal (Kirchhoff's law).
    Substitute into RTE (REFERENCE) to obtain

    \startformula
        \DERIV{I_\nu}{s} = - \ABSCOEF(I_\nu - B_\nu(T)) \EQSTOP
    \stopformula

    For temperatures occuring in the atmosphere the Planck function in the
    microwave region is represented well by the Rayleigh-Jeans approximation
    which relates the spectral radiance at a given frequency linearly to
    temperature

    \startformula
        B_\nu(T) \approx \frac{2 \nu^2 k T}{c^2} \EQSTOP
    \stopformula

    By expressing the spectral radiance $I_\nu$ with the concept of brightness
    temperature $\BT$ (which is the temperature a blackbody would have to have
    in order to reproduce the emission by a grey body) and the Rayleigh-Jeans
    approximation, the radiative transfer equation can be expressed exclusively
    in terms of temperatures:

    \startformula
        \DERIV{\BT}{s} = - \ABSCOEF (\BT - T) \EQSTOP
    \stopformula

\stopsection


\startsection[title={A Solution for Ground-based Radiometer Applications}]

    Assumption of horizontally homogeneous atmosphere, relate distance
    towards radiometer $s$ to height above radiometer $z$

    \startformula
        \DERIV{s}{z} = - \frac{1}{\cos(\theta)} \EQCOMMA
    \stopformula

    where the azimuth angle $\theta$ is defined as the deviation from
    zenith. Because height increases with height but radiation arriving at
    the radiometer is downwelling, the sign of the derivative is negative.

    In order to solve the radiative transfer equation after the coordinate
    transformation, optical depth $\OD$ is introduced

    \startformula
    \startalign[n=3,align={left,right,left}]
        \NC \NC \OD(s) = \NC \int_{s_0}^{s} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \OD(z) = \NC
            - \frac{1}{\cos(\theta)} \int_{z_0}^{z} \ABSCOEF(u) \diff u \NR
        \NC \Rightarrow~ \NC \DERIV{\OD}{z} = \NC
            - \frac{\ABSCOEF}{\cos(\theta)} \EQCOMMA \NR
    \stopalign
    \stopformula

    and REFERENCE is multiplied on both sides by $e^{\OD}$ and
    rearranged, yielding

    \startformula
        \DERIV{\BT}{z} e^\OD + \frac{\ABSCOEF \BT e^\OD}{\cos(\theta)}
        = \DERIV{(\BT e^\OD)}{z}
        = - \frac{\ABSCOEF T e^\OD}{\cos(\theta)} \EQSTOP
    \stopformula

    Integrating this from the surface ($z = 0$) to space ($z = \infty$)
    gives an expression for the brightness temperature measured by the
    radiometer $\BT(0)$:

    \startformula
        \BT(0) = \BT(\infty) e^{\OD(\infty)} + \frac{1}{\cos(\theta)}
            \int_{0}^{\infty} \ABSCOEF(z) T(z) e^{\OD(z)} \diff z \EQSTOP
    \stopformula

    $T_B(\infty)$ is given by the cosmic background (describe), the
    absorption coefficient can be determined from the atmospheric profile
    (see section REFERENCE). Mention limitation of fixed zenith angle and
    that it is wrong to assume angle is constant. Refraction, curvature.

\stopsection


\startsection[title=Atmospheric Extinction]

    \placefigure[top][fig:absorption]
        {Absorption coefficients (black) and contributions of individual terms
        (other) according to the models of \cite[Liebe1993] (gaseous) and
        \cite[Turner2016] (cloud) for a atmospheric layer at 850 hPa pressure,
        0°C temperature and saturation, containing 0.1 g/kg of liquid water.
        The arrows mark HATPRO channels.
        }
        {\externalfigure[absorption][width=\textwidth]}

    Size of molecules and cloud particles too small for effective scattering
    therefore only absorption is considered in microwave region. Only at
    droplet sizes occuring during precipitation does scattering become
    important, these cases are problematic due to little knowledge of acutal
    LWC and droplet size distributions.

    Main contributions to absorption of microwave radiation by oxygen and water
    vapor, which have rotational and vibrational transitions, and liquid
    water, whose apsorption can be treated with the Rayleigh-approximation.
    Other effects include pressure-broadening, self-broadening, non-resonant
    continuum absorption.

    Multiple absorption models exist in the literature (e.g. Rosenkranz, Liebe,
    MONORTM which is based on HITRAN or similar?). These usually describe
    the most important lines, correct for the missing ones and parameterize
    the continuum. Cloud absorption is parameterized by a double-Debey model.
    Models are formulated in terms of refractivity $N$ (which is complex
    refractive index minus 1), absorption can be calculated by (REFERENCE?)

    \startformula
        \ABSCOEF = \frac{4 \pi \nu}{c}~ {\rm Im}(N) \EQCOMMA
    \stopformula

    where $c$ is the speed of light and $\nu$ is frequency.

    Here model by \cite[Liebe1993], containing ??? lines ..., is used to
    calculate absorption coefficients of gaseous absorption and model by
    \cite[Turner2016] for cloud liquid water absorption.

    Example of absorption in typical atmospheric conditions shown in Figure
    REF. Selecting frequencies along the sides of the absorption complexes
    of oxygen (V band) and water vapor (K band) allows profiling of the
    atmosphere as radiation at each frequency is differently absorbed along the
    way.

\stopsection


\startsection[title={Choice of State Vector Variables},reference={ch:statevector}]

    Pressure as fixed variable (recalculated by hydrostatic equilibrium
    after each iteration, check if this is good approximation when compared
    to radiosonde measurements SHOW THIS).

    \startformula
        p(z) = p(z_0) + \exp \left( - g \int_{z_0}^{z} \frac{1}{R(h) T(h)}  \diff h \right)
    \stopformula
    
    Temperature and humidity as variable state quantities. To reduce
    dimensionality: use knowledge of qsat to combine water vapor and liquid
    water content into a single variable qtot.  No representation of ice due to
    negligible absorption in microwave region (see below INSERT REF). The
    individual components are then recovered by a partition function

    \startformula
        \DERIV{\QLIQ}{\RHL} = \QSAT \startcases
            \NC 0 \MC s \lt 0.95 \NR
            \NC \cos \left( \frac{\RHL - 1.05}{0.1} \frac{\pi}{2} \right)^2
                \MC 0.95 \le s \le 1.05 \EQCOMMA\NR
            \NC 1 \MC 1.05 \lt s \NR
        \stopcases
    \stopformula

    where

    \startformula
        \RHL = \frac{\QTOT}{\QSAT} = \frac{\QVAP + \QLIQ}{\QSAT} \EQSTOP
    \stopformula

    Hewison, Deblonde, (COSMO7 fixes RH at 100 \% in clouds). Integrate,
    get values for qliq and qvap.

    \startformula
        \QLIQ(\RHL) = \startcases
            \NC 0 \MC s \lt 0.95 \NR
            \NC \frac{\QSAT}{2} \left( \RHL - 0.95 - \frac{0.1}{\pi}
                \cos \left( \frac{\pi \RHL}{0.1} \right) \right)
                \MC 0.95 \le s \le 1.05 \NR
            \NC \QLIQ(1.05) + \QSAT (\RHL - 1.05) \MC 1.05 \lt s \NR
        \stopcases
    \stopformula

    and from REF to s = qtot/qsat

    \startformula
        \QVAP(\RHL) = \QTOT(\RHL) - \QLIQ(\RHL) \EQSTOP
    \stopformula

    \placefigure[top][fig:gauss_verification]
        {Histograms of temperature (left), specific humidity (center) and
        the natural logarithm of specific humidity (right) for the 1339 m
        level of the radiosonde dataset (section \in[]).
        }
        {\externalfigure[gauss_verification][width=\textwidth]}

    Additionally: use ln(qtot) in state vector to enforce positivity and

    better error characteristics.

    \cite[Hewison2006]

\stopsection


\startsection[title=Weighting Functions]

    \placefigure[top][fig:jacobian_frequency]
        {Normalized weighting functions for the V band (left) and K band
        (right) channels of the HATPRO instrument (see section \in[ch:hatpro])
        simulated by the radiative transfer model introduced in section
        \in[ch:mwrtm] for an upwards looking view from an altitude of 612 m.
        The V band weighting functions are with respect to temperature, the
        K band weighting functions with respect to the natural logarithm of
        humidity. Lighter colors correspond to channels of higher frequency.
        The assumed atmospheric profile is the U.S. standard atmosphere with
        relative humidity decreasing from 70 \% at the surface to 10 \% at 11
        km above which it is constant.
        }
        {\externalfigure[jacobian_frequency][width=\textwidth]}

    Weighting functions/averaging kernels. Obtained from the linearization of
    solution. Important for analyzing the information content and capabilities
    of resolution of a radiometer. Give examples for different angles. Plots!

\stopsection


\startsection[title={Implementation of a Numerical Model Prototype},reference=ch:mwrtm]

    Presentation of a custom implementation of a line-by-line model. Based on
    absorption models by \cite[Liebe1993] for gaseous absorption and
    \cite[Turner2016] for cloud liquid water absorption. It features complete
    forward-mode automatic differentiation with respect to temperature and
    humidity. Jacobians can therefore be calculated exactly and relatively
    quick. The following sections expand on the individual aspects of this
    model, describe challenges of implementation and evaluate the model
    performance including the determination of the model's error covariance
    matrix for the Bayesian retrieval.

    \startsubsection[title={Motivation}]

        With existing models for radiative transfer, why build another one?
        Driven by the question if a specialized model, stripped down to its
        bare essentials can perform similarly well as full featured models such
        as MonoRTM or ARTS. Hope for better convergence properties if exact
        Jacobians are available. ARTS (and the not yet available RTTOV-gb)
        provides linearizations but is quite heavy machinery.

        Learning experience, understanding by doing. Knowing each component of
        the retrieval method well should help overall understanding of results.
        
        Implementation completely in a high-level language allows easy
        integration of model with other data analysis, quick setup and rapid
        development of new features in the future. Thanks to numpy it is still
        relatively fast.

        Expected is a somewhat worse model performance than reference models
        such as MONORTM (against which it will be compared). Suspected main
        contributor of errors: Bending due to changing refractive index
        neglected. This affects all angles away from zenith. 

        TODO: hint at MonoRTM comparison, is it really that bad, what about
        sensitivity mostly in lower atmosphere? Besides, forward model errors
        are accounted for in Bayesian approach, this error should appear in
        MONORTM/MWRTM cov matrix.
        
    \stopsubsection

    \startsubsection[title=Discretization and Interpolation]

        Smoothing: interpolation scheme is very important and might affect the
        resulting brightness temperatures calculated by the model. Proposed
        discretizations: add levels dynamically to keep all extrema, this is
        good for inversion situations but only applicable if the regions with
        problematic values are known beforehand, which is not the case for
        real-time retrievals. When NWP model is used for a-priori, it is
        convenient to use the model grid, but impossible for stations like
        Innsbruck where model topography often ends much higher up than
        actual location of instrument. Generally it is desirable to have higher
        resolution in the lower atmosphere, where more stuff happens and
        at which heights the model has high sensitivity, so numerical errors
        should be kept as small as possible.

        Compromise between resolution necessary for numerical model (as many
        levels as possible) and actual information content (only few levels).
        More levels are more expensive to calculate. Inclusion of upper
        atmosphere or not.

        Levels in input atmospheric state determine size of Jacobian and
        therefore also computational cost. Higher resolution does not mean
        that retrieval results in higher resolved features. Changes to the
        profile in iterative approach are goverened by the weighting functions,
        only features resolvable by this set of basis functions can effectively
        be removed or introduced to a retrieved profile (is this what Hewison
        talks about when he says the technique has problems with inversion
        displacement?). Important! Fine structure of first guess is likely
        preserved during retrieval. Smooth profiles likely better since they
        do not allow for missinterpretation of small scale features which are
        only an artefact of the initial value of the iterative scheme.

        Numerical discretization very important for accurate results, high
        vertical resolution especially in the lower troposphere is required to
        obtain accurate numerical results.

    \stopsubsection

    \startsubsection[title=Fast Absorption Prediction]

        A major part of the radiative transfer calculations is the determination of
        the absorption coefficient of each layer of the discretization. Although
        the models of \cite[Liebe1993] and \cite[Turner2016] are already fairly
        simple, the forward model spends a large fraction of computing time in
        these components. The purpose of a \infull{FAP} (\FAP) is to reduce this
        time. It also simplifies the task of model linearization greatly
        (section \in[ch:linearization]). The {\FAP} is chosen to be a polynomial of
        the state vector variables $p$, $T$, $\LNQ$ (although with some prior
        processing of the variables, as seen shortly). The polynomial coefficients
        are determined by multiple linear regression.
        
        In a first implementation both gaseous and cloud absorption were modelled
        together by a single polynomial of the state vector variables. Up to
        polynomials of degree 5 yielded large errors in the approximated absorption
        coefficients. The polynomial was not able to adequately represent the
        strong nonlinearity at the cloud threshold. Higher order polynomials are
        affected by combinatorial blowup of interaction terms and numerical
        stability, therefore a more refined approach is taken.

        Instead of fitting a polynomial to the combined gaseous and cloud
        absorption, the components are approximated separately. Specific cloud
        absorption according to the model by \cite[Turner2016] is only a function
        of temperature. A 5th order polynomial in $T$ is sufficient to approximate
        cloud absorption at a selected frequency with good accuracy. The gaseous
        absorption is modelled by $p$, $T$ and $\QVAP$, with the latter obtained by
        separating $\QTOT$ into its vapor and liquid components using ???).
        \cite[Lohnert2004] and \cite[Hewison2006] used a third order polynomial of
        these variables without interaction terms and claimed good accuracy. This
        was not observed here, therefore a 5th order polynomial with all
        interaction terms is used in this work. Additionally, instead of using the
        absorption coefficient $\ABSCOEF$ as the target of the regression directly,
        $\ln(\ABSCOEF)$ is used in order to guarantee positivity of the
        approximated $\ABSCOEF$.

        TODO: describe test data set. FAP scpecialized for each frequency.
        Evaluate FAP performance for each line of the HATPRO. Training data:
        synthetic gridded data representative for a wide variety of atmospheric
        states. Climatology is test dataset. Climatology is not used for training
        due to profiles being mostly at night and night, therefore temperatures are
        not representative of whole range of realistic values. Climatology is
        valuable as independent test set. Mention that FAP errors contribute to
        covariance matrix.

    \stopsubsection

    \startsubsection[title=Linearization,reference=ch:linearization]

        Necessary for iterative optimal estimation approach but also gives
        information about the sensitivity of the measurement to different layers of
        the atmosphere (weighting functions). Quality of linearization important
        for convergence of iterative retrieval procedure. Literature review:
        everyone seems to be working with finite differences, but often complaints
        that these calculations take long. ARTS offers approximated Jacobians
        but with a model reduced to the essentials it is possible to evaluate the
        Jacobian exactly and this is done here.

        Brute force: can be used with every model. Problems with selection of
        perturbations, non-linearity (e.g. at liquid water boundary). One-sided
        derivatives have bad accuracy (first order finite difference).
        Possibility of truncating the Jacobian at upper levels to save
        computing time.

        Analytical alternatives to finite differences: symbolic and automatic
        differentiation. Symbolic differentiation often requires significant
        effort and has the problem of combinatorial blowup of expressions.
        Automatic differentiation evaluates the derivatives at each node of
        the computation graph directly. There are two ways of performing
        automatic differentiation: the forward-mode type moves from the input
        towards the output, computing the derivatives with respect to each
        input along the way. The reverse-model type moves from the output
        towards the input, computing the derivative of each output with respect
        to each node of the computation graph along the way. Both techniques
        yield the same results but might be very different in terms of
        computational cost. Generally speaking reverse-mode is suitable for
        problems with many inputs and only few outputs, while forward mode
        differentiation is more efficient for problems with more outputs than
        inputs.

        A radiative transfer model, with many atmospheric layers and only
        a few brightness temperatures as output seems well suited for
        reverse-model differentiation. The model presented in the next section
        uses forward mode despite that due to it being more easy to implement
        and due to the merging of computational paths only happening at the end
        of the model calculation and having little interaction in between
        (absorption coefficients are only dependend on their own layer),
        therefore the computational advantage of reverse-mode is likely to be
        offset by the more complicated implementation.

        TODO: mention that there are code generators for automatic
        differentiation, tie in backprop if NNs are used and maybe make a
        computational graph for the model, showing that most of the model
        happens in parallel.

    \stopsubsection


\stopsection


\startsection[title={Characterization of Errors},reference={ch:rtm_errors}]

    Building part of the forward model covariance matrix.

    Compare exact Jacobian with brute force Jacobian.

    FAP errors: determine from climatology by comparison of exact
    calculations with FAP predictions.

    Discretization errors: deterine from climatology by comparing
    interpolated profiles with full resolution profiles.

\stopsection


\startsection[title=Model Comparison]

    Need arises for quantification of spectral errors as seen in the previous
    chapter. Refer to comparison study.

    Existing dataset from Massaro/Meyer, using Rosenkranz absorption etc.

    Implementation of a MonoRTM wrapper. Short description of MonoRTM,
    reference ARM models, version 5.2.

    Clouds vs. elevation scanning. \cite[Blumberg2015] used MonoRTM version 4.2
    at different elevation angles. It is unclear how they managed this.

\stopsection


\startsection[title=Elevation Scanning]

    \placefigure[top][fig:jacobian_angle]
        {Normalized weighting functions for 54.94 GHz (left) and 58.00 GHz
        (right) for different zenith angles simulated by the radiative transfer
        model introduced in section \in[ch:mwrtm]. The 0° weighting function
        for 0° (upward looking) is the  blue line, angles 60°, 65°, 70°, 75°,
        80°, 85° are the gray lines, with lighter colors being larger zenith
        angles. Atmospheric profile and radiometer location are the same as in
        Figure \in[fig:jacobian_frequency].
        }
        {\externalfigure[jacobian_angle][width=\textwidth]}

    Off-zenith observations. Additional challenge for retrieval. RTM has to
    take refraction and Earth's curvature into account. Horizontal homogeneity
    becomes increasingly important for flat angles, which is problematic the
    closer one comes to the surface. Humidity most easily violates assumption.
    Crewell + Löhnert did regression with multiple angles of HATPRO and used
    only four most opaque channels since path lengths are short. Radiometer
    needs to be accurate to detect small changes. Obstacles in path complicate
    situtation.

    Implemented RTM does not have refractivity included yet. This means using
    transparent channels is not possible in retrieval but As Crewell+Löhnert
    2007 did the four most opaque are included. Also in unison with Massaro
    who only used four most opaque channels off-zenith as predictors in
    regression. Comparison to IGMK calculation shows standard deviations
    smaller than radiometer noise and path lengths are so short (100 to 2000 m)
    that refractivity is suspected to be negligible. Show weighting functions
    from two channels at all angles from model.

\stopsection


