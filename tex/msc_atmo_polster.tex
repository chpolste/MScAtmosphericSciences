\usecolors[xwi]
\usemodule[chart]

\define\DocTitleFooter{Bayesian Retrieval of Thermodynamic Atmospheric Profiles from a Ground-based MWR}
\define\Author{Christopher Polster}
\define\DateOfCompletion{2016-07-??} % TODO

\input mycommands

\mainlanguage[en]
\hyphenation{}

% DIN-A4 Paper
\setuppapersize[A4]
\setuplayout[
        backspace=35mm,
        width=150mm,
        header=0mm,
        footer=0mm
        ]

% Create links in Table of Contents and set pdf metadata
\setupinteraction[
        state=start,
        color=black,
        contrastcolor=black,
        style=,
        focus=standard,
        title={Bayesian Retrieval of Thermodynamic Atmospheric Profiles from a Ground-based Microwave Radiometer},
        subtitle={Masters's Thesis, 2016},
        author={Christopher Polster},
        ]
\placebookmarks[chapter,section,subsection]

% Titles for TOC and Refs
\setupheadtext[
        content={Table of Contents},
        pubs=References
        ]

% Fonts
% Text uses serif font
\setupbodyfont[11pt,serif]
\definebodyfontenvironment[11pt][a=12pt,b=13pt,c=14pt,d=20pt]

% Headings etc. are sans-serif
\definefont[CoverHeadingFont][dejavusans at 19pt]
\definefont[AbstractHeadingFont][dejavusans at 11pt]
\definefont[ChapterFont][dejavusans at 19pt]
\definefont[SectionFont][dejavusans at 13pt]
\definefont[SubsectionFont][dejavusans at 12pt]
\definefont[TOCHeadingFont][dejavusans at 11pt][2]
\definefont[PageNumberFont][dejavusans at 10pt]
\definefont[FooterFont][dejavusans at 8pt]
\definefont[FigureFont][dejavusans at 8.5pt][1.1] % the 1.1 is line height
\definefont[FigureCaptionFont][dejavusansbold at 8.5pt][1.1]

% Styles for headings etc.
\definealternativestyle[FigureStyle][\FigureFont]
\definealternativestyle[FigureCaptionStyle][\FigureCaptionFont]
\definealternativestyle[TOCStyle][\TOCHeadingFont]
\definealternativestyle[ChapterStyle][\ChapterFont]
\definealternativestyle[SectionStyle][\SectionFont]
\definealternativestyle[SubsectionStyle][\SubsectionFont]

% Don't reset section numbering in new chapter
\definestructureresetset[nosecreset][1,1,0][1] % [part, chapter, section][default]
\setuphead[sectionresetset=nosecreset]
% No chapter numbering, apply heading styles
\setuphead[chapter][number=no,style=ChapterStyle,page=yes]
\setuphead[section][style=SectionStyle,sectionsegments=section]
\setuphead[subsection][style=SubsectionStyle,sectionsegments=section:subsection]

% Footnotes
\define[1]\footnotebrack{\narrownobreakspace\high{[#1]}}
\setupnotation[footnote][alternative=text]
\setupfootnotes[
        way=bytext,
        frameoffset=0mm,
        topframe=on,
        rule=off,
        toffset=1mm,
        roffset=-14cm,
        before={\blank[7mm]}%,
        %textcommand=\footnotebrack
        ] % fixes weird spacing when only one line of footnote

% Table of contents
\setuplist[chapter][style=TOCStyle]
\setupcombinedlist[section,subsection][alternative=c]
\setuplist[section][width=9mm]
\setuplist[subsection][width=9mm,margin=9mm]

% Figures
\setupexternalfigures[directory=figures/]
\setupcaptions[figure][
        style={FigureStyle},
        suffix={:},
        headstyle={FigureCaptionStyle},
        prefixsegments=none,
        width=fit,
        way=bytext,
        spaceafter=2mm
        ]

% Formulas
\defineseparatorset[none][][]
\setupformulas[way=bytext,prefixsegments=none,numberseparatorset=none]
% Increase spacing around binary relation symbols (default is 5mu plus 5mu).
\thickmuskip=10mu plus 5mu

% Bibliography
\setupbibtex[database=literature,sort=author]
\setuppublications[criterium=cite,alternative=apa,sorttype=bbl,refcommand=authoryear]
\setuppublicationlist[artauthoretallimit=40,criterium=all]
\setupcite[authoryears][pubsep={; },lastpubsep={; },inbetween={ },compress=no]

% Taken from bibl-apa.tex and added doi
\setuppublicationlayout[article]{%
   \insertartauthors{}{ }{\insertthekey{}{ }{}}%
   \insertpubyear{(}{). }{\unskip.}%
   \insertarttitle{\bgroup }{\egroup. }{}%
   \insertjournal{\bgroup \it}{\egroup}
    {\insertcrossref{In }{}{}}%
   \insertvolume
    {\bgroup \it, }
    {\egroup\insertissue{\/(}{)}{}\insertpages{, }{.}{.}}
    {\insertpages{, pp. }{.}{.}}%
   \insertdoi{ doi:}{.}{}%
   \insertnote{ }{.}{}%
   \insertcomment{}{.}{}%
}


% Section block setups
% This could probably be solved more elegantly, but it worked for my
% bachelor's thesis and I don't see the point in redoing something that works.

% Cover
\definesectionblock[CoverSectionBlock][,]
\setupsectionblock[CoverSectionBlock][page=right]
\startsectionblockenvironment[CoverSectionBlock]
    \setupinterlinespace[line=14pt]
    \setupwhitespace[medium]
    \raggedcenter
\stopsectionblockenvironment

% Table of Contents
\definesectionblock[TOCSectionBlock][,]
\setupsectionblock[TOCSectionBlock][page=right]
\startsectionblockenvironment[TOCSectionBlock]
    \setupwhitespace[0.5em]
    \setuppagenumbering[state=stop,alternative=doublesided]
\stopsectionblockenvironment

% Frontmatter: Acknowledgements, Preface
\setupsectionblock[frontpart][page=right]
\startsectionblockenvironment[frontpart]
    \setuplayout[footerdistance=8mm,footer=6mm]
    \setcounter[userpage][1] % Reset page counter
    \setuppagenumbering[
            state=start,
            location={footer,right},
            left={},
            right={},
            alternative=doublesided,
            style=\PageNumberFont
            ]
    \setupuserpagenumber[numberconversion=romannumerals]
    \setupwhitespace[medium]
    \setupinterlinespace[line=1.5em]
\stopsectionblockenvironment

\definesectionblock[AbstractSectionBlock][,]
\setupsectionblock[AbstractSectionBlock][page=right]
\startsectionblockenvironment[AbstractSectionBlock]
    \setuppagenumbering[state=stop,alternative=doublesided]
    \setupinterlinespace[line=1.5em]
    \setupwhitespace[big]
    \setupnarrower[middle=10mm]
    \page[right]
\stopsectionblockenvironment

% Bodymatter: all text
\setupsectionblock[bodypart][page=no]
\startsectionblockenvironment[bodypart]
    \setuplayout[footerdistance=8mm,footer=6mm]
    \setcounter[userpage][1] % Reset page counter
    \setuppagenumbering[
            state=start,
            location={footer,right},
            left={},
            right={},
            alternative=doublesided,
            style=\PageNumberFont
            ]
    \setupfootertexts[{\FooterFont {\DocTitleFooter}}]
                     [pagenumber]
                     [pagenumber]
                     [{\FooterFont Master's Thesis of {\Author} (2016)}]
    \setupbackgrounds[footer][text][topframe=on]
    \setupwhitespace[medium]
    \setupinterlinespace[line=1.5em]
\stopsectionblockenvironment


% Backmatter: References
\setupsectionblock[backpart][page=no]
\startsectionblockenvironment[backpart]
    \setuppagenumbering[alternative=doublesided,style=\PageNumberFont]
    \setuplayout[footerdistance=8mm,footer=6mm]
    \setupfootertexts[{\FooterFont {\DocTitleFooter}}]
                     [pagenumber]
                     [pagenumber]
                     [{\FooterFont Master's Thesis of {\Author} (2016)}]
    \setupbackgrounds[footer][text][topframe=on]
    \setupwhitespace[medium]
    \setupinterlinespace[line=1.5em]
\stopsectionblockenvironment


\starttext

\startsectionblock[CoverSectionBlock]

    \dontleavehmode
    \blank[5mm]
    \dontleavehmode
    \externalfigure[acinn_logo][height=15mm] % TODO: find high-resolution logo
    \blank[2mm]
    University of Innsbruck \break
    Institute of Atmospheric and Cryospheric Sciences
    \blank[20mm]
    \dontleavehmode
    \blackrule[width=5cm,height=0.5mm]
    \blank[20mm]

    {\CoverHeadingFont \strut 
    Bayesian Retrieval of Thermodynamic\blank[5mm]
    Atmospheric Profiles from a \blank[5mm]
    Ground-based Microwave Radiometer
    \strut}

    %{\CoverHeadingFont \strut \DocSubtitle \strut}

    \blank[20mm]

    \dontleavehmode
    \blackrule[width=5cm,height=0.5mm]

    \blank[20mm]

    {\bold Master's Thesis in Atmospheric Sciences}

    \blank[10mm]

    Submitted to the Faculty of Geo- and Atmospheric Sciences \break
    in Partial Fulfillment of the Requirements for the Degree of Master of Science

    \blank[5mm]

    by {\bold \Author}

    \blank[15mm]

    Innsbruck, \DateOfCompletion

    \blank[15mm]

    Advisor: Prof. Dr. Mathias Rotach \break
\stopsectionblock

\startsectionblock[AbstractSectionBlock]

    \dontleavehmode
    \startsubject[title=Declaration]
    I confirm that this is my own work and the use of all material from other
    sources has been properly and fully acknowledged.
        \dontleavehmode
        \blank[1mm]

        Innsbruck, \DateOfCompletion

        \vfill

        \hbox{\Author}
        
        %\hbox{student number}

        %\hbox{Email}
    \stopsubject

    \page[right]

    \dontleavehmode
    \blank[10mm]
    \startnarrower
        {\AbstractHeadingFont Abstract}
        
        ...

        \dontleavehmode\blank[1cm]
        {\AbstractHeadingFont Zusammenfassung}

        ...

        \stopnarrower


\stopsectionblock

\startsectionblock[TOCSectionBlock]

    \completecontent

\stopsectionblock

\startfrontmatter

    \startchapter[title=Acknowledgements]
        \input ch_acknowledgements
    \stoptitle

    \page[even,empty] % TODO: take care of this when all is written

    \startchapter[title=Preface]
        \input ch_preface
    \stoptitle

    %\page[even,empty]

\stopfrontmatter

\startbodymatter
    
    \input flowcharts

    \startchapter[title=Introduction]
        \input ch_introduction
    \stopchapter

    \startchapter[title=Retrieval Techniques]
        \input ch_retrieval
    \stopchapter

    \startchapter[title=Radiative Transfer and State Representation]
        \input ch_radiative_transfer
    \stopchapter

    \startchapter[title={Instrument, Data and Methodology}]
        \input ch_instrument
    \stopchapter

    \startchapter[title=Retrieval Results and Discussion]
        \input ch_results
    \stopchapter

    \startchapter[title=Conclusions and Outlook]
        \input ch_conclusions
    \stopchapter

\stopbodymatter

\startbackmatter

    \startchapter[title=References]

        All online references were last accessed 2016-08-07.
        \blank[1em]

        \placepublications

    \stopchapter
    \page[left]

\stopbackmatter

\stoptext
